# Progress Log for bootstralph
# Started: 2026-01-17T21:48:21+01:00

## 2026-01-17 - impl-013: Implement Expo scaffolder wrapper

### Completed
- Created `src/scaffolders/expo.ts` with full Expo scaffolding support
- Wraps `create-expo-stack@latest` CLI with bootstralph-specific configurations
- Supports Expo Router and React Navigation for routing
- Supports Uniwind (with NativeWind fallback + migration), NativeWind, Tamagui, Unistyles, and StyleSheets for styling
- Integrates with mobile backends: Supabase (with AsyncStorage), Convex (convex-react-native), Firebase (@react-native-firebase)
- Auth support: Clerk (@clerk/clerk-expo), better-auth (@better-auth/expo), Supabase Auth
- E2E testing: Maestro (with flow setup) and Detox (with config and example tests)
- Deployment: EAS Build configuration generation
- Pre-commit hooks: Lefthook, Husky, prek support
- Linting/Formatting: oxlint, Biome, ESLint, oxfmt, Prettier
- Environment template generation with EXPO_PUBLIC_ prefix convention

### Technical Details
- Uses Jest preset for unit testing (jest-expo)
- Creates test setup with @testing-library/react-native
- Generates Maestro flows in `.maestro/` directory
- Generates Detox configuration in `.detoxrc.js`
- Supabase client uses AsyncStorage for session persistence
- Uniwind migration swaps nativewind for uniwind post-scaffold

### Type check: PASSED

## 2026-01-17 - impl-014: Implement React Native CLI scaffolder wrapper

### Completed
- Created `src/scaffolders/rn-cli.ts` with full React Native CLI scaffolding support
- Wraps `npx @react-native-community/cli init` with bootstralph-specific configurations
- Prerequisite checking: Detects Xcode (macOS) and Android SDK installation
- Displays prerequisite warning with option to switch to Expo if tools missing
- React Navigation setup: @react-navigation/native + @react-navigation/native-stack
- Creates navigation structure with RootNavigator and example HomeScreen
- Styling support: Uniwind, NativeWind, Tamagui, StyleSheets
- Integrates with mobile backends: Supabase (with AsyncStorage), Convex (convex-react-native), Firebase (@react-native-firebase)
- Auth support: Clerk, better-auth (@better-auth/react-native), Supabase Auth
- E2E testing: Maestro (with flow setup) and Detox (with config and example tests)
- Deployment: Fastlane configuration generation with iOS/Android lanes
- Pre-commit hooks: Lefthook, Husky, prek support
- Linting/Formatting: oxlint, Biome, ESLint, oxfmt, Prettier
- Environment template generation

### Technical Details
- Uses Jest preset for unit testing (react-native preset)
- Creates test setup with @testing-library/react-native
- Generates Maestro flows in `.maestro/` directory
- Generates Detox configuration in `.detoxrc.js` with project-specific paths
- Fastlane Fastfile with build_dev, build_prod, and beta lanes for iOS/Android
- Supabase client uses AsyncStorage for session persistence
- Uniwind setup includes tailwind.config.js and babel.config.js updates
- NativeWind v4 setup includes metro.config.js with withNativeWind wrapper
- Tamagui setup includes tamagui.config.ts and react-native-reanimated plugin

### Type check: PASSED

## 2026-01-17 - impl-015: Implement React Router v7 scaffolder wrapper

### Completed
- Created `src/scaffolders/react-router.ts` with full React Router v7 (Framework Mode) scaffolding support
- Wraps `npx create-react-router@latest` (successor to Remix v2) with bootstralph-specific configurations
- Uses Vite for bundling (built-in to React Router v7)
- Tailwind CSS setup with @tailwindcss/vite plugin and tailwind.config.ts
- shadcn/ui setup with components.json and cn() utility helper
- State management: Zustand, Jotai, TanStack Query support
- ORM support: Drizzle (edge-compatible with @libsql/client or @neondatabase/serverless), Prisma
- Backend integrations: Supabase (@supabase/ssr), Convex, Firebase
- Auth support: better-auth, Clerk (@clerk/react-router), Supabase Auth
- Testing: Vitest (unit) with vite-tsconfig-paths, Playwright (e2e)
- Pre-commit hooks: Lefthook (YAML config), Husky (with lint-staged ESM config)
- Linting: oxlint, Biome, ESLint support
- Formatting: oxfmt, Biome, Prettier support
- Environment template generation with VITE_ prefix convention

### Technical Details
- Uses `~/` alias convention for imports (React Router v7 standard)
- Generates Vitest config at project root with app/** test inclusion
- Playwright configured for port 5173 (Vite default)
- Drizzle schema stored in app/db/ directory
- Supabase client provides both browser and server client helpers for loaders/actions
- Convex provider created in app/providers/ directory
- Husky config creates ESM lint-staged.config.js (not .cjs) for ESM projects
- Lefthook config includes stage_fixed: true for auto-staging fixed files

### Type check: PASSED

## 2026-01-17 - impl-016: Implement Astro scaffolder wrapper

### Completed
- Created `src/scaffolders/astro.ts` with full Astro scaffolding support
- Wraps `npm create astro@latest` CLI with bootstralph-specific configurations
- Uses Vite for bundling (Astro's default)
- File-based routing (Astro's built-in routing system)
- Styling: Tailwind CSS (via `astro add tailwind`), vanilla CSS
- React islands support via `astro add react` for interactive components
- MDX support via `astro add mdx` for content-rich pages
- Deployment adapters: Vercel, Netlify, Cloudflare (via `astro add`)
- ORM support: Drizzle (edge-compatible with @libsql/client or @neondatabase/serverless), Prisma
- Backend integrations: Supabase, Convex (via React islands with ConvexProvider), Firebase
- Auth support: better-auth (native Astro integration with middleware), Clerk (@clerk/astro with server-side middleware), Supabase Auth
- Testing: Vitest (unit with Astro's getViteConfig helper), Playwright (e2e)
- Pre-commit hooks: Lefthook (YAML config), Husky (with lint-staged ESM config), prek
- Linting: oxlint, Biome, ESLint support
- Formatting: oxfmt, Biome, Prettier (with prettier-plugin-astro)
- Environment template generation with PUBLIC_ prefix convention (Astro standard)

### Technical Details
- Uses `--template basics --yes --no-git --typescript strict` for non-interactive scaffold
- Generates Vitest config using Astro's `getViteConfig` helper for proper integration
- Playwright configured for port 4321 (Astro default dev server port)
- Drizzle schema stored in src/db/ directory
- Convex setup creates ConvexProvider in src/components/ for use in React islands
- better-auth setup creates auth.ts in src/lib/ and API route at pages/api/auth/[...all].ts
- Clerk setup creates middleware.ts for server-side auth protection
- Content Collections support: generates config.ts with blog collection and example MDX post
- Supabase client uses `import.meta.env` for environment variables

### Type check: PASSED

## 2026-01-17 - impl-017: Implement Hono/Elysia API template

### Completed
- Created `src/scaffolders/api.ts` with full API scaffolding support for both Hono and Elysia
- Wraps `npm create hono@latest` and `bun create elysia` with bootstralph-specific configurations
- Framework choice: Hono (edge-first, multi-runtime) or Elysia (Bun-native, TypeScript-first)
- Hono template selection based on deployment target: cloudflare-workers, vercel, netlify, nodejs, bun
- ORM support: Drizzle (with edge-compatible drivers), Prisma (with adapter for Cloudflare)
- Auth support: better-auth with framework-specific handler setup (Hono routes, Elysia plugin)
- Testing: Vitest with framework-appropriate test examples (Hono request API, Elysia Eden client)
- Deployment: Cloudflare Workers, Vercel, Netlify, Fly.io, Railway, Render
- Pre-commit hooks: Lefthook (YAML config), Husky (with lint-staged ESM config)
- Linting: oxlint, Biome, ESLint support
- Formatting: oxfmt, Biome, Prettier support
- Environment template generation with deployment-specific variables

### Technical Details
- Hono scaffolding uses `npm create hono@latest` with template selection based on deployment
- Elysia scaffolding always uses `bun create elysia` (Bun-native framework)
- Drizzle setup: SQLite/D1 for Cloudflare, PostgreSQL via Neon for other deployments
- Prisma setup: Uses @prisma/adapter-libsql for Cloudflare edge compatibility
- better-auth integration: Creates auth config with database adapter + framework-specific handler
- Hono handler mounts better-auth at /api/auth/* routes
- Elysia handler creates plugin with prefix '/api/auth'
- Vitest configured for Node.js environment with coverage via v8 provider
- Cloudflare deployments include wrangler as dev dependency for local dev and deployment

### Type check: PASSED

## 2026-01-17 - impl-018: Implement create command orchestration

### Completed
- Created `src/commands/create.ts` with full wizard orchestration
- Orchestrates the complete flow: project type → framework → features → deployment → tooling → scaffold
- Preset support for quick project setup: saas, mobile, api, content, universal, fullstack
- Full wizard flow with proper cancellation handling at each step
- Configuration validation using `validateAllSelections` before scaffolding
- Confirmation prompt before starting scaffold process
- Framework-specific scaffolder dispatching (Next.js, TanStack Start, Expo, React Native CLI, React Router v7, Astro, Hono, Elysia)
- Options builder functions for each scaffolder to handle type conversions
- Configuration summary display before scaffolding
- Proper handling of optional properties for exactOptionalPropertyTypes
- Updated `src/index.ts` to use the new `handleCreate` function

### Preset Configurations
- **saas**: Next.js + Tailwind/shadcn + Drizzle + Supabase + better-auth + Vercel
- **mobile**: Expo + Uniwind + Supabase + Clerk + EAS Build + Expo Router
- **api**: Hono + Drizzle + better-auth + Cloudflare
- **content**: Astro + Tailwind + Drizzle + Supabase + Vercel
- **universal**: Expo + Tamagui + Supabase + Clerk + EAS Build
- **fullstack**: Next.js + Tailwind/shadcn + Drizzle + Supabase + better-auth + Vercel

### Technical Details
- Uses promptProjectType, promptFramework, promptFeatures, promptDeployment, promptTooling from prompts/
- Calls appropriate scaffolder based on framework selection
- Builds scaffold options conditionally to satisfy TypeScript's exactOptionalPropertyTypes
- Handles directory existence check with overwrite confirmation
- Displays warnings and next steps from scaffold result
- Exports PRESET_CONFIGS, runWizard, applyPreset, runScaffolder, displayConfigSummary

### Type check: PASSED

## 2026-01-17 - impl-019: Implement CLAUDE.md template generator

### Completed
- Created `src/ralph/claudemd.ts` with CLAUDE.md generation and file writing utilities
- Created `src/templates/CLAUDE.md.ts` with comprehensive template generator
- Template includes all project configuration sections:
  - Project overview (platform, framework, package manager)
  - Tech stack (styling, state, ORM, backend, auth, testing, tooling, deployment)
  - Development workflow (getting started, testing, code quality, database commands)
  - Coding standards (architecture patterns, styling, state management, database, auth)
  - Important files (configuration, environment)
  - Conventions (git, code style, testing)
  - Ralph loop notes (usage, best practices)

### Technical Details
- `generateClaudeMd(config)` generates full CLAUDE.md content based on ClaudeMdConfig
- `writeClaudeMd(options)` writes CLAUDE.md to project directory with overwrite control
- `generateClaudeMdContent(config)` generates content without writing (for preview/testing)
- `hasClaudeMd(projectPath)` checks if CLAUDE.md exists
- `readClaudeMd(projectPath)` reads existing CLAUDE.md content
- Framework-specific patterns for Next.js, TanStack Start, React Router v7, Astro, Expo, RN CLI, Hono, Elysia
- Styling-specific patterns for Tailwind/shadcn, NativeWind, Uniwind, Tamagui
- State management patterns for Zustand, TanStack Query, Jotai
- Database patterns for Drizzle and Prisma
- Auth patterns for better-auth, Clerk, Supabase Auth

### Type check: PASSED

## 2026-01-17 - impl-020: Implement skills installation via openskills

### Completed
- Created `src/ralph/skills.ts` with full skills installation via openskills CLI
- Uses `execa` to spawn openskills CLI commands (openskills has no programmatic API)
- Integrates with existing `SKILLS_MATRIX` from `src/compatibility/matrix.ts`

### Features
- `isOpenskillsInstalled()` - Check if openskills CLI is available
- `installOpenskills()` - Install openskills globally via npm
- `installSkills(options)` - Install all skills for a project configuration
- `installSingleSkill(projectPath, skillName, source)` - Install a single skill by name
- `getSkillsToInstall(config)` - Get list of skills based on SkillsConfig
- `getSkillsInfo(projectPath, config)` - Get skill info with installed status
- `listInstalledSkills(projectPath)` - List skills installed in a project
- `hasAgentsMd(projectPath)` - Check if AGENTS.md exists
- `readAgentsMd(projectPath)` - Read AGENTS.md content

### Technical Details
- Marketplace management: Auto-adds known marketplaces (anthropics/skills, vercel-labs/agent-skills, obra/superpowers, expo/skills)
- Source mapping: Converts skill sources to marketplace format (e.g., @jezweb/claude-skills → jezweb/claude-skills)
- Handles "already installed" responses gracefully
- Syncs AGENTS.md after skill installation via `openskills sync`
- Properly handles execa v9 output types (string | Uint8Array | unknown[])
- Respects exactOptionalPropertyTypes for SkillInfo interface

### Skills Matrix Integration
Based on SkillsConfig (framework, backend, orm, auth, styling), installs:
- **All projects**: planning-with-files, test-driven-development, systematic-debugging, verification-before-completion
- **Next.js**: react-best-practices, vercel-deploy-claimable, web-design-guidelines
- **TanStack Start/React Router**: react-best-practices, web-design-guidelines
- **Expo/RN CLI**: expo-app-design, expo-deployment, upgrading-expo
- **Supabase**: supabase-operations
- **Drizzle**: drizzle-orm-d1, drizzle, drizzle-migration
- **better-auth**: better-auth
- **Clerk**: clerk-pack
- **Tailwind**: tailwind-v4-shadcn

### Type check: PASSED

## 2026-01-17 - impl-021: Implement Lefthook configuration generator

### Completed
- Created `src/templates/lefthook.yml.ts` with comprehensive Lefthook YAML template generator
- Created `src/ralph/hooks.ts` with full git hooks configuration management

### Features - lefthook.yml.ts Template Generator
- `generateLefthookYml(config)` - Main generator function
- Framework-aware glob patterns (Astro support for .astro files, standard patterns for others)
- Linter support: oxlint (with --fix), Biome (check --write), ESLint (--fix)
- Formatter support: oxfmt, Biome (format --write), Prettier (with Astro plugin when needed)
- TypeScript type checking command
- Commitlint support for commit message validation
- `stage_fixed: true` for auto-staging fixed files
- Parallel execution enabled by default
- Smart Biome handling: skips separate format step when Biome handles both linting and formatting
- Framework-specific generators: generateNextjsLefthook, generateTanStackLefthook, generateReactRouterLefthook, generateAstroLefthook, generateExpoLefthook, generateRNCliLefthook, generateHonoLefthook, generateElysiaLefthook

### Features - hooks.ts Configuration Manager
- `writeHooksConfig(options)` - Write hooks configuration for any supported tool
- `hasHooksInstalled(projectPath, tool)` - Check if hooks are installed
- `getHooksConfigPath(projectPath, tool)` - Get config file path for a tool
- `readHooksConfig(projectPath, tool)` - Read existing hooks configuration
- Lefthook support: Generates lefthook.yml with lint/format/typecheck commands
- Husky support: Creates .husky directory, pre-commit hook, lint-staged.config.js (ESM format), optional commit-msg hook with commitlint.config.cjs
- prek support: Generates .pre-commit-config.yaml (pre-commit compatible format)
- Optional hook installation via `installHooks` option
- Proper error handling and overwrite control

### Technical Details
- Uses ESM format for lint-staged config (lint-staged.config.js with export default)
- Uses CommonJS for commitlint config (commitlint.config.cjs) for ESM project compatibility
- Husky pre-commit script sources husky.sh and runs npx lint-staged
- prek warning about npm usage for Node.js hook environments
- Manual steps returned for user guidance (lefthook install, husky install, prek install)

### Type check: PASSED

## 2026-01-17 - impl-022: Implement Claude Code hooks setup

### Completed
- Created `src/templates/.claude/settings.json.ts` with Claude Code settings template generator
- Created `src/ralph/settings.ts` with settings file writing and management utilities

### Features - settings.json.ts Template Generator
- `generateClaudeSettings(config)` - Main generator function for Claude Code settings
- `generateClaudeSettingsJson(config)` - Generate JSON string output
- `generateMinimalClaudeSettings(config)` - Generate settings without hooks
- `generateClaudeSettingsLocal()` - Generate settings.local.json template
- Permissions system with allow/deny patterns using Tool(pattern) syntax
- Framework-specific patterns for Next.js, TanStack Start, React Router v7, Astro, Expo, RN CLI, Hono, Elysia
- ORM-specific patterns for Drizzle and Prisma
- Backend-specific patterns for Supabase, Firebase, Convex
- Auth-specific patterns for Clerk, better-auth, Supabase Auth
- Common deny patterns for .env files, key files, secrets directories, cloud credentials, SSH keys
- PreToolUse hooks for reliable security enforcement (workaround for deny rule enforcement issues)

### Features - settings.ts Settings Manager
- `writeClaudeSettings(options)` - Write .claude/settings.json and optionally settings.local.json
- `hasClaudeSettings(projectPath)` - Check if settings exist
- `readClaudeSettings(projectPath)` - Read existing settings
- `getClaudeSettingsPath(projectPath)` - Get settings file path
- `getClaudeSettingsLocalPath(projectPath)` - Get local settings file path
- `generateClaudeSettingsContent(config)` - Generate content without writing
- `createClaudeSettingsConfig(options)` - Create config from common project options
- Automatic .gitignore update to exclude settings.local.json
- Overwrite control for existing settings

### Technical Details
- Settings file hierarchy: .claude/settings.local.json > .claude/settings.json > ~/.claude/settings.json
- PreToolUse hooks execute before tools and can block (exit 2) or allow (exit 0)
- Hook matchers: Read, Write, Edit, Bash with grep-based pattern matching
- Security warning included about permissions.deny not being reliably enforced (GitHub issues #6631, #6699, #4467)
- Sensitive file patterns include: .env*, *.key, *.pem, /secrets/, /.aws/, /.ssh/, service-account*.json
- Dangerous command patterns include: sudo, rm -rf, chmod 777, curl, wget, mysqldump, pg_dump

### Type check: PASSED

## 2026-01-17 - impl-023: Implement Docker sandbox configuration

### Completed
- Created `src/templates/docker-compose.yml.ts` with Docker configuration template generators
- Created `src/ralph/sandbox.ts` with sandbox configuration manager

### Features - docker-compose.yml.ts Template Generators
- `generateDockerComposeYml(config)` - Generate docker-compose.yml for custom container approach
- `generateDockerfile(config)` - Generate Dockerfile for Claude Code container (node:20 base)
- `generateEnvExample(config)` - Generate .env.example with API key placeholders
- `generateDevcontainerJson(config)` - Generate VS Code devcontainer.json
- `generateMinimalDevcontainerJson()` - Generate minimal devcontainer (features-only)
- `generateStartClaudeScript(config)` - Generate start-claude.sh for docker sandbox approach
- `generateFirewallScript()` - Generate firewall-setup.sh for domain whitelisting (iptables)
- `generateDockerignore()` - Generate .dockerignore for container builds

### Features - sandbox.ts Configuration Manager
- `detectDockerEnvironment()` - Auto-detect Docker environment (sandbox, devcontainer, compose, none)
- `writeSandboxConfig(options)` - Write sandbox configuration based on detected environment
- `writeAllSandboxConfigs(options)` - Write all three approaches (sandbox, devcontainer, compose)
- `hasSandboxConfig(projectPath)` - Check what Docker configs exist in a project
- `getRecommendedDockerSetup()` - Get recommended Docker setup with commands

### Environment Detection
- Checks for Docker installation (`docker --version`)
- Checks if Docker daemon is running (`docker info`)
- Checks for Docker Desktop sandbox feature (`docker sandbox --help`)
- Detects VS Code environment (TERM_PROGRAM or `code` command)
- Returns recommendations based on detected environment

### Docker Approaches Supported
1. **Docker Desktop Sandbox** (simplest): `docker sandbox run claude`
   - Uses `docker/sandbox-templates:claude-code` image
   - Automatic credential management
   - Generates: start-claude.sh script

2. **DevContainer** (VS Code): `.devcontainer/devcontainer.json`
   - Uses `ghcr.io/anthropics/devcontainer-features/claude-code:1` feature
   - Seamless VS Code integration
   - Generates: .devcontainer/devcontainer.json

3. **Custom Dockerfile** (CI/CD): `docker-compose.yml` + `Dockerfile`
   - Full control over container environment
   - Optional network filtering with iptables
   - Generates: docker-compose.yml, Dockerfile, .env.example, .dockerignore, firewall-setup.sh

### Security Features
- Network filtering capability via cap_add: NET_ADMIN
- Domain whitelisting script (api.anthropic.com, registry.npmjs.org, github.com)
- .env file exclusion from git
- API keys via environment variables, never hardcoded

### Type check: PASSED

## 2026-01-17 - impl-024: Implement Ralph setup orchestration

### Completed
- Created `src/ralph/setup.ts` with full Ralph setup orchestration
- Orchestrates all Ralph components: CLAUDE.md, skills, hooks, settings, Docker sandbox
- Main function `setupRalph(options)` runs the complete setup process
- Interactive variant `setupRalphInteractive(options)` shows progress spinners for each step

### Features
- `setupRalph(options)` - Main entry point with configurable skip options
- `setupRalphInteractive(options)` - Interactive version with @clack/prompts spinners
- `setupRalphQuick(projectPath, projectName, framework)` - Minimal setup with sensible defaults
- `addRalphToExistingProject(projectPath)` - Placeholder for adding Ralph to existing projects

### Setup Steps (in order)
1. **CLAUDE.md** - Project-specific guidance for Claude Code
2. **Skills** - Install relevant skills via openskills CLI
3. **Git Hooks** - Configure pre-commit hooks (Lefthook/Husky/prek)
4. **Claude Settings** - Generate .claude/settings.json with permissions and hooks
5. **Docker Sandbox** - Configure Docker environment (sandbox/devcontainer/compose)

### Configuration Options
- `skipSkills` - Skip skills installation
- `skipDocker` - Skip Docker configuration
- `skipHooks` - Skip git hooks setup
- `skipSettings` - Skip Claude Code settings
- `skipClaudeMd` - Skip CLAUDE.md generation
- `installHooks` - Install hooks after generating config
- `overwrite` - Overwrite existing files
- `verbose` - Enable verbose output
- `dockerEnvironment` - Specify Docker environment (auto-detect if not provided)
- `allDockerConfigs` - Write all Docker configurations

### Result Tracking
- `filesWritten` - List of files created/modified
- `skillsInstalled` - List of successfully installed skills
- `skillsFailed` - List of skills that failed to install
- `warnings` - Any warnings during setup
- `errors` - Any errors during setup
- `nextSteps` - Suggested next steps for the user

### Re-exports
- Sub-module functions for direct access: writeClaudeMd, installSkills, writeHooksConfig, writeClaudeSettings, writeSandboxConfig, detectDockerEnvironment

### Type check: PASSED

## 2026-01-17 - impl-025: Implement init command for existing projects

### Completed
- Created `src/commands/init.ts` with full init command implementation
- Detects existing project configuration from package.json and config files
- Supports all frameworks: Next.js, TanStack Start, React Router v7, Astro, Expo, React Native CLI, Hono, Elysia
- Auto-detects package manager from lock files (bun, pnpm, yarn, npm)
- Updated `src/index.ts` to use the new handleInit from commands module

### Project Detection Features
- **Framework detection**: Analyzes dependencies to identify framework
- **Platform detection**: Determines web, mobile, universal, or api based on framework
- **Styling detection**: Tailwind, shadcn/ui, Tamagui, Uniwind, NativeWind, Unistyles
- **State detection**: Zustand, Jotai, TanStack Query
- **ORM detection**: Drizzle, Prisma
- **Backend detection**: Supabase, Convex, Firebase
- **Auth detection**: better-auth, Clerk, Supabase Auth
- **Linter detection**: oxlint, Biome, ESLint (from deps and config files)
- **Formatter detection**: oxfmt, Biome, Prettier (from deps and config files)
- **Testing detection**: Vitest, Jest, Playwright, Cypress, Detox, Maestro
- **Pre-commit detection**: Lefthook, Husky, prek (from deps and config files)

### User Flow
1. Validates project directory has package.json
2. Checks if Ralph is already initialized (CLAUDE.md, .claude/settings.json)
3. Analyzes project and displays detected configuration
4. User confirms or modifies detected configuration
5. User selects which Ralph components to set up (CLAUDE.md, skills, hooks, settings, Docker)
6. Runs `setupRalphInteractive()` with selected options
7. Displays results: files created, warnings, errors, next steps

### Exported Functions
- `handleInit()` - Main command handler
- `detectProjectConfig()` - Detect config from existing project
- `confirmConfiguration()` - User confirmation flow
- `promptSetupOptions()` - Setup component selection
- `readPackageJson()` - Read and parse package.json
- `detectFramework()` - Framework detection logic
- `detectPlatform()` - Platform detection logic

### Type check: PASSED

## 2026-01-17 - impl-026: Implement add command for post-scaffold features

### Completed
- Created `src/commands/add.ts` with comprehensive feature addition capabilities
- Supports adding 12 different feature types to existing projects
- Interactive feature selection menu when no feature is specified
- Provider/tool selection prompts for each feature type

### Addable Features
1. **auth** - Add better-auth, Clerk, or Supabase Auth
2. **orm** - Add Drizzle or Prisma ORM
3. **backend** - Add Supabase, Convex, Firebase, or custom backend
4. **state** - Add Zustand, Jotai, or TanStack Query
5. **styling** - Add Tailwind, shadcn/ui, or mobile styling solutions
6. **testing** - Add Vitest or Jest unit testing
7. **e2e** - Add Playwright, Cypress, Maestro, or Detox E2E testing
8. **linter** - Add oxlint, Biome, or ESLint
9. **formatter** - Add oxfmt, Prettier, or Biome
10. **hooks** - Add Lefthook, Husky, or prek pre-commit hooks
11. **skill** - Install openskills skill by name or from list
12. **ralph** - Full Ralph setup (CLAUDE.md, settings, skills)

### Technical Details
- Uses `detectProjectConfig()` from init.ts to analyze existing project
- Validates framework compatibility before adding features
- Framework-specific package selection (e.g., @clerk/nextjs vs @clerk/expo)
- Generates configuration files based on framework conventions
- Installs packages using project's detected package manager
- Supports --force, --yes, and --provider flags for automation
- Builds config objects conditionally to satisfy exactOptionalPropertyTypes
- Integrates with Ralph setup components (writeClaudeMd, writeClaudeSettings, installSkills, writeHooksConfig)

### File Generation
- Auth: auth.ts config, middleware.ts (Clerk/Next.js), .env.example
- ORM: drizzle.config.ts or prisma/schema.prisma, schema files, client files
- Backend: Client configuration files, setup instructions
- State: Example store/atoms files
- Testing: vitest.config.ts or jest.config.js, setup files
- E2E: playwright.config.ts, .maestro/, .detoxrc.js, example tests
- Linter: .oxlintrc.json or biome.json
- Formatter: .prettierrc
- Hooks: lefthook.yml, .husky/, or .pre-commit-config.yaml

### Exported Functions
- `handleAdd(args)` - Main CLI command handler
- `addFeature(feature, provider, options)` - Add feature to project
- `promptFeatureSelection()` - Interactive feature menu
- Individual handlers: addAuth, addORM, addBackend, addState, addStyling, addTesting, addE2E, addLinter, addFormatter, addHooks, addSkill, addRalph

### Type check: PASSED

## 2026-01-17 - impl-027: Implement SaaS preset

### Completed
- Created `src/presets/saas.ts` with comprehensive SaaS preset configuration
- Created `src/presets/index.ts` with preset registry and exports

### Features
- Main `SAAS_PRESET` configuration optimized for production SaaS apps:
  - Next.js with App Router
  - Tailwind CSS + shadcn/ui for rapid UI development
  - Drizzle ORM for type-safe database access
  - Supabase for database, realtime, and storage
  - better-auth for flexible authentication
  - Vercel deployment
  - Vitest + Playwright for testing
  - oxlint + oxfmt + prek for fast tooling

### Preset Variants
- `SAAS_CLERK_PRESET` - Uses Clerk for enterprise auth (MFA, SSO, organizations)
- `SAAS_PRISMA_PRESET` - Uses Prisma ORM instead of Drizzle
- `SAAS_TANSTACK_PRESET` - Uses TanStack Start instead of Next.js
- `SAAS_CONVEX_PRESET` - Uses Convex for real-time backend

### Helper Functions
- `getSaaSPreset()` - Get the default SaaS preset
- `getSaaSVariant(variant)` - Get a specific variant by name
- `getAllSaaSVariants()` - Get all SaaS preset variants
- `presetToProjectConfig(preset)` - Convert preset to project config format
- `formatPresetInfo(preset)` - Display preset information as formatted string

### Preset Registry (index.ts)
- `PRESETS` - Record of all presets by ID
- `getPreset(id)` - Get preset by ID
- `getAllPresets()` - Get all available presets
- `isValidPreset(id)` - Check if preset ID exists

### Technical Details
- PresetConfig interface includes: id, name, description, platform, framework, styling, state, orm, backend, auth, deployment, linter, formatter, unitTesting, e2eTesting, preCommit, packageManager, features list, skills list
- Each preset includes recommended skills from the SKILLS_MATRIX
- Variants use spread operator to inherit base configuration
- presetToProjectConfig handles optional properties correctly for exactOptionalPropertyTypes

### Type check: PASSED

## 2026-01-17 - impl-028: Implement Mobile preset

### Completed
- Created `src/presets/mobile.ts` with comprehensive Mobile preset configuration
- Updated `src/presets/index.ts` to export and register the Mobile preset

### Features
- Main `MOBILE_PRESET` configuration optimized for cross-platform mobile apps:
  - Expo (managed workflow) for cross-platform development
  - Uniwind for Tailwind-style styling (2.5x faster than NativeWind)
  - Expo Router for file-based navigation
  - Clerk for native mobile authentication
  - Supabase for backend services (database, storage, realtime)
  - EAS Build for cloud builds and deployment
  - Jest + Maestro for testing
  - oxlint + oxfmt + prek for fast tooling

### Preset Variants
- `MOBILE_BETTER_AUTH_PRESET` - Uses better-auth with @better-auth/expo for self-hosted auth
- `MOBILE_NATIVEWIND_PRESET` - Uses established NativeWind ecosystem
- `MOBILE_TAMAGUI_PRESET` - Uses Tamagui design system with optimizing compiler
- `MOBILE_CONVEX_PRESET` - Uses Convex for real-time backend
- `MOBILE_FIREBASE_PRESET` - Uses Firebase services (Firestore, Storage, Cloud Functions)
- `MOBILE_DETOX_PRESET` - Uses Detox for deterministic E2E testing

### Helper Functions
- `getMobilePreset()` - Get the default Mobile preset
- `getMobileVariant(variant)` - Get a specific variant by name
- `getAllMobileVariants()` - Get all Mobile preset variants

### Technical Details
- Follows same pattern as SaaS preset for consistency
- Uses spread operator for variants to inherit base configuration
- Includes appropriate skills from SKILLS_MATRIX for mobile development
- Registered in PRESETS registry for use with `--preset mobile` flag

### Type check: PASSED

## 2026-01-17 - impl-029: Implement API preset

### Completed
- Created `src/presets/api.ts` with comprehensive API preset configuration
- Updated `src/presets/index.ts` to export and register the API preset

### Features
- Main `API_PRESET` configuration optimized for edge-first API development:
  - Hono for edge-first, multi-runtime API development
  - Drizzle ORM for type-safe database access (with D1/LibSQL)
  - better-auth for API authentication (JWT, sessions)
  - Cloudflare Workers for edge deployment
  - Vitest for unit testing
  - oxlint + oxfmt + prek for fast tooling

### Preset Variants
- `API_ELYSIA_PRESET` - Bun-native API with Elysia for maximum performance, Fly.io deployment
- `API_PRISMA_PRESET` - Uses Prisma ORM with edge adapter
- `API_VERCEL_PRESET` - Serverless API with Hono on Vercel
- `API_NODE_PRESET` - Node.js API for traditional hosting (Railway/Render)
- `API_SUPABASE_PRESET` - API with Supabase for database and auth
- `API_FLY_PRESET` - Globally distributed API on Fly.io

### Helper Functions
- `getAPIPreset()` - Get the default API preset
- `getAPIVariant(variant)` - Get a specific variant by name
- `getAllAPIVariants()` - Get all API preset variants

### Technical Details
- Follows same pattern as SaaS and Mobile presets for consistency
- Uses spread operator for variants to inherit base configuration
- Includes appropriate skills from SKILLS_MATRIX for API development
- Registered in PRESETS registry for use with `--preset api` flag
- Uses `fly-io` deployment target (not `fly` - fixed type error)

### Type check: PASSED

## 2026-01-17 - impl-030: Implement Monorepo preset

### Completed
- Created `src/presets/fullstack.ts` with comprehensive Fullstack/Monorepo preset configuration
- Updated `src/presets/index.ts` to export and register the Fullstack preset

### Features
- Main `FULLSTACK_PRESET` configuration optimized for Turborepo monorepos:
  - Turborepo for monorepo management and build orchestration
  - Next.js for web application (apps/web)
  - Bun workspaces for package management (Turborepo 2.6+ stable support)
  - Shared packages: ui, db, tsconfig, eslint-config
  - Drizzle ORM for type-safe database access (shared schema)
  - Supabase for backend services
  - better-auth for authentication (shared across apps)
  - Tailwind CSS + shadcn/ui
  - Vitest + Playwright for testing
  - oxlint + oxfmt + prek for fast tooling
  - Remote caching with Turborepo
  - Parallel task execution

### Preset Variants
- `FULLSTACK_MOBILE_PRESET` - Adds Expo mobile app for universal (web + mobile) apps
- `FULLSTACK_TANSTACK_PRESET` - Uses TanStack Start instead of Next.js
- `FULLSTACK_CONVEX_PRESET` - Uses Convex for real-time backend
- `FULLSTACK_CLERK_PRESET` - Uses Clerk for enterprise auth (MFA, SSO, organizations)
- `FULLSTACK_PRISMA_PRESET` - Uses Prisma ORM instead of Drizzle
- `FULLSTACK_API_PRESET` - Adds Hono API service in apps/api

### Helper Functions
- `getFullstackPreset()` - Get the default Fullstack preset
- `getFullstackVariant(variant)` - Get a specific variant by name
- `getAllFullstackVariants()` - Get all Fullstack preset variants

### Technical Details
- Follows same pattern as SaaS, Mobile, and API presets for consistency
- Uses spread operator for variants to inherit base configuration
- Includes turborepo and monorepo-management skills for monorepo development
- Uses bun workspaces (not pnpm) per review-022 finding
- Documents --cwd flag usage for workspace-specific installs
- Registered in PRESETS registry for use with `--preset fullstack` flag

### Type check: PASSED

## 2026-01-17 - impl-031: Write unit tests for compatibility matrix

### Completed
- Created `vitest.config.ts` with test configuration for the project
- Created `tests/compatibility.test.ts` with comprehensive unit tests (114 tests total)

### Test Coverage
- **PLATFORMS**: Platform configuration, framework availability per platform
- **FRAMEWORKS**: All 8 framework configurations, bundler/routing/styling/testing options
- **INCOMPATIBILITY_RULES**: Rule structure validation, unique IDs
- **areSelectionsCompatible()**: Compatibility checking including:
  - Framework + routing conflicts (Next.js + TanStack Router, etc.)
  - Biome + ESLint/Prettier mutual exclusivity
  - Expo + Vitest/Playwright incompatibility
  - ORM and auth provider mutual exclusivity
  - Deployment target mutual exclusivity
- **getIncompatibleOptions()**: Returns all incompatible options for a selection
- **EDGE_COMPATIBILITY**: Edge runtime ORM support verification
- **checkEdgeORMCompatibility()**: Cloudflare/Vercel/Railway/Fly.io ORM requirements
- **STYLING_COMPATIBILITY**: Platform-specific styling options
- **getStylingForPlatform()**: Web/mobile/universal styling filtering
- **getRecommendedStyling()**: Default styling per platform
- **TESTING_COMPATIBILITY**: Unit and E2E testing framework options
- **LINTERS & FORMATTERS**: Configuration structure, speed, stability
- **DEFAULTS**: Default recommendations for all platforms
- **getFrameworksForPlatform()**: Platform to framework mapping
- **getFrameworkConfig()**: Framework configuration retrieval
- **SKILLS_MATRIX**: Skill definitions and conditions
- **getSkillsForConfig()**: Config-based skill selection with deduplication

### Technical Details
- Vitest configured with v8 coverage provider
- Tests use .js extension in imports for ESM compatibility
- Test file located in tests/ directory (outside src/)
- All 114 tests passing

### Type check: PASSED
### Tests: 114 passed

## 2026-01-17 - impl-032: Write unit tests for filtering logic

### Completed
- Created `tests/filters.test.ts` with comprehensive unit tests (104 tests total)
- Tests cover all filter functions in `src/compatibility/filters.ts`

### Test Coverage
- **getAvailableFrameworks()**: Framework filtering by platform, recommended flags
- **getAvailableStyling()**: Platform/framework-aware styling filtering, web/mobile/universal distinctions
- **getAvailableStateManagement()**: State management options by framework
- **getAvailableORM()**: ORM options by framework (Drizzle, Prisma, none)
- **getAvailableBackend()**: Backend options by framework (Supabase, Firebase, Convex, custom)
- **getAvailableAuth()**: Auth provider options with framework-aware descriptions, Supabase recommendation
- **getAvailableLinters()**: Linter options (oxlint, Biome, ESLint)
- **shouldShowFormatterQuestion()**: Biome mutual exclusivity logic
- **getAvailableFormatters()**: Formatter options based on linter selection
- **getAvailableUnitTesting()**: Platform-aware unit testing frameworks (Vitest vs Jest)
- **getAvailableE2ETesting()**: Platform-aware E2E testing frameworks (Playwright/Cypress vs Maestro/Detox)
- **getAvailableDeployment()**: Framework-specific deployment targets
- **filterOptions()**: Generic incompatibility filtering
- **validateSelections()**: Full selection validation with error detection

### Test Categories
- Framework filters: 8 tests
- Styling filters: 9 tests
- State management filters: 6 tests
- ORM filters: 6 tests
- Backend filters: 6 tests
- Auth filters: 9 tests
- Linter filters: 3 tests
- Formatter filters: 8 tests
- Unit testing filters: 9 tests
- E2E testing filters: 9 tests
- Deployment filters: 10 tests
- Generic filter options: 6 tests
- Validate selections: 11 tests
- Integration tests: 4 tests

### Technical Details
- Tests verify FilteredOption interface compliance (value, label, description, recommended)
- Tests verify incompatibility rule enforcement (Biome+ESLint, Biome+Prettier, Expo+Vitest, etc.)
- Tests verify platform-specific recommendations match DEFAULTS from matrix
- Integration tests verify consistent options for SaaS (Next.js), Mobile (Expo), and API (Hono) presets

### Type check: PASSED
### Tests: 218 passed (114 compatibility + 104 filters)

## 2026-01-17 - impl-033: Write integration tests for scaffolders

### Completed
- Created `tests/scaffolders.test.ts` with comprehensive integration tests (107 tests total)
- Tests cover all 7 scaffolder modules without invoking external CLIs

### Test Coverage

#### Next.js Scaffolder (40 tests)
- **buildCreateNextAppArgs**: Package manager flags, App/Pages Router, Tailwind options, turbopack, import alias
- **collectAdditionalDependencies**: State management (Zustand, Jotai, TanStack Query), ORM (Drizzle, Prisma), backend (Supabase, Convex, Firebase), auth (Clerk, better-auth, Supabase Auth), testing (Vitest, Jest), E2E (Playwright, Cypress), linting (oxlint, Biome), formatting (Prettier, oxfmt), pre-commit hooks (Lefthook, Husky)
- **buildNextSteps**: cd command, env setup, ORM push commands, Playwright install, pre-commit install

#### TanStack Start Scaffolder (10 tests)
- **buildCreateStartArgs**: Biome/ESLint toolchain, shadcn/TanStack Query add-ons, package manager support
- **collectAdditionalDependencies**: State management, edge-compatible ORM deps, auth deps, testing deps
- **buildNextSteps**: cd command, ORM setup steps

#### React Router v7 Scaffolder (6 tests)
- **buildCreateReactRouterArgs**: Basic args, template flag
- **collectAdditionalDependencies**: Edge-compatible ORM deps for Cloudflare/Vercel
- **buildNextSteps**: Dev command with package manager

#### Expo Scaffolder (15 tests)
- **buildCreateExpoStackArgs**: Expo Router/React Navigation, NativeWind/Tamagui/Uniwind styling, package manager (--yarn format)
- **collectAdditionalDependencies**: Uniwind migration, Clerk/better-auth Expo SDKs, Supabase with AsyncStorage, Convex React Native, Firebase RN, testing-library deps, Detox E2E
- **buildNextSteps**: EAS setup, expo start command

#### React Native CLI Scaffolder (9 tests)
- **checkPrerequisites**: hasXcode, hasAndroidStudio properties
- **collectAdditionalDependencies**: Testing-library deps (always added), better-auth RN SDK, Clerk deps, state management, Detox E2E
- **buildNextSteps**: Platform-specific run commands, Fastlane setup

#### Astro Scaffolder (11 tests)
- **buildCreateAstroArgs**: Template, TypeScript strict, --no-git, --yes flags
- **collectAdditionalDependencies**: Clerk Astro SDK, better-auth, Prettier with Astro plugin, Drizzle, Vitest, backend deps
- **buildNextSteps**: Astro dev command

#### API (Hono/Elysia) Scaffolder (11 tests)
- **getHonoTemplate**: Cloudflare Workers, Vercel, Netlify, Node.js templates
- **collectAdditionalDependencies**: Drizzle with D1/Neon drivers, Prisma with edge adapter, better-auth, Vitest, wrangler
- **buildNextSteps**: Framework-specific dev commands, wrangler info

#### Cross-Scaffolder Integration (5 tests)
- Consistent ScaffoldResult interface across all scaffolders
- Common package manager support (bun, pnpm, npm, yarn)
- Consistent ORM dependencies across web frameworks
- Consistent auth dependencies across web frameworks
- Platform-appropriate testing (Vitest for web, Jest/testing-library for mobile)

### Technical Details
- Tests use internal interfaces (CreateStartArgsOptions, CreateExpoStackArgsOptions, etc.) matching actual implementations
- Verified styling deps handled by separate setup functions (not collectAdditionalDependencies) for RN CLI and Astro
- Verified Jest comes with React Native/Expo presets, so scaffolders only add testing-library deps
- Verified package manager flag formats differ by scaffolder (--use-bun vs --bun vs --yarn)

### Type check: PASSED
### Tests: 325 passed (114 compatibility + 104 filters + 107 scaffolders)

## 2026-01-17 - impl-034: Write E2E tests for full wizard flow

### Completed
- Fixed existing `tests/e2e.test.ts` with 76 comprehensive E2E tests
- Tests cover the complete flow from preset/config to scaffolder options
- All tests pass without invoking external CLIs or interactive prompts

### Test Coverage

#### Preset Configurations (11 tests)
- PRESET_CONFIGS validation (all presets defined, valid platforms, valid frameworks, compatibility)
- applyPreset() for all 6 presets (saas, mobile, api, content, universal, fullstack)
- Preset validation (all presets pass validateAllSelections)

#### Preset Modules (18 tests)
- Preset Registry (getAllPresets returns array, isValidPreset, getPreset by ID)
- SaaS Preset (default, variants array, specific variant retrieval)
- Mobile Preset (default, variants array, specific variant retrieval)
- API Preset (default, variants array, specific variant retrieval)
- Fullstack Preset (default, variants array, specific variant retrieval)

#### Create Command Flow (6 tests)
- Configuration building (valid web, mobile, API configs)
- Invalid configuration detection (Expo+Vitest, Biome+ESLint, Expo+Playwright)

#### Init Command Flow (23 tests)
- Project detection (Next.js, Expo, TanStack Start, React Router v7, Astro, Hono, Elysia, RN CLI)
- Feature detection (Drizzle, Prisma, Supabase, Firebase, Clerk, better-auth, Tailwind, shadcn, state libs)
- Tooling detection (oxlint, Biome, ESLint, Vitest, Jest, Playwright, Lefthook, Husky)
- Package manager detection (bun, pnpm, yarn, npm via lock files)

#### Platform-Framework Compatibility (5 tests)
- Valid frameworks for each platform (web, mobile, universal, api)
- Consistent defaults for each platform

#### End-to-End Config Flow (6 tests)
- Valid scaffolder config production for all 6 presets (SaaS, Mobile, API, Content, Universal, Fullstack)

#### Validation Edge Cases (4 tests)
- Empty selections handling
- Partial selections handling
- Minimal valid configuration
- Multiple incompatibility detection

### Bug Fixes During Implementation
- Fixed test expectations for `getAllPresets()` - returns array, not object
- Fixed test expectations for `getAllSaaSVariants()`, `getAllMobileVariants()`, etc. - return arrays with preset IDs
- Fixed Fullstack mobile variant feature check (look for "Expo mobile app" string)
- Fixed DEFAULTS.e2eTesting.api expectation (is 'playwright', not undefined)
- Fixed empty selections validation expectation (validator checks conflicts, not required fields)

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-17 - impl-035: Create README documentation

### Completed
- Verified existing README.md is comprehensive and up-to-date
- README already contains all necessary documentation including:
  - Ralph Loop pattern explanation and AFK mode usage
  - Cost warning about token usage
  - Features overview with compatibility-aware selection
  - Supported frameworks table (Next.js, TanStack Start, React Router v7, Expo, RN CLI, Astro, Hono/Elysia)
  - Quick start guide with prerequisites
  - Preset configurations (saas, mobile, api, fullstack)
  - PRD commands (prd, ralph, afk-ralph.sh)
  - Project structure documentation
  - Compatibility matrix examples
  - Skills installation table by stack
  - Docker sandbox configuration
  - Configuration tables (tooling defaults, auth providers, deployment targets)
  - Development instructions

### Technical Details
- README includes all commands: create, init, add, prd, ralph
- Preset documentation matches implemented presets (saas, mobile, api, content, universal, fullstack)
- Skills matrix documentation matches SKILLS_MATRIX from src/compatibility/matrix.ts
- Docker approaches documented: sandbox, devcontainer, custom Dockerfile

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-17 - impl-036: Configure npm publishing

### Completed
- Updated `package.json` with complete npm publishing configuration
- Added `homepage` field pointing to GitHub repository README
- Added `publishConfig` with public access and npm registry URL
- Added `sideEffects: false` for better tree-shaking in bundlers

### Existing Configuration (already in place)
- `name`, `version`, `description`, `license`, `author`
- `main`, `module`, `types`, `exports` for dual ESM/CJS support
- `bin` for CLI executable (`bootstralph`)
- `files` array limiting published files to `dist/` only
- `prepublishOnly` script to build before publish
- `engines` field requiring Node.js 18.19.0+
- `keywords` for npm search discoverability
- `repository` and `bugs` URLs

### Package Contents (verified via npm pack --dry-run)
- README.md (10.6kB)
- dist/index.js (406.0kB) - ESM bundle
- dist/index.cjs (415.7kB) - CommonJS bundle
- dist/index.d.ts + dist/index.d.cts - TypeScript declarations
- Source maps for debugging
- Total package size: 471.4kB (compressed)

### Publishing Instructions
```bash
# Login to npm (first time only)
npm login

# Publish to npm
npm publish

# Or with explicit public access
npm publish --access public
```

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)
### Build: PASSED

## 2026-01-17 - impl-037: Add OpenTUI and SolidJS dependencies

### Completed
- Installed OpenTUI and SolidJS dependencies: @opentui/core, @opentui/solid, solid-js
- Configured TypeScript for SolidJS JSX compilation (jsx: preserve, jsxImportSource: solid-js)
- Updated tsup.config.ts to use esbuild-plugin-babel with babel-preset-solid for TSX files
- Added babel dev dependencies: @babel/core, @babel/preset-typescript, babel-preset-solid, esbuild-plugin-babel

### Technical Details
- OpenTUI v0.1.74 installed (latest, uses Zig FFI for performance-critical rendering)
- SolidJS v1.9.9 installed (stable)
- Babel preset configured with @babel/preset-typescript for type stripping and babel-preset-solid for JSX transformation
- Build uses esbuild-plugin-babel with filter: /\.tsx$/ to only transform SolidJS TSX files
- Non-TSX TypeScript files continue to use esbuild's native TypeScript handling

### Package Updates
- Dependencies added: @opentui/core ^0.1.74, @opentui/solid ^0.1.74, solid-js ^1.9.9
- Dev dependencies added: @babel/core ^7.28.6, @babel/preset-typescript ^7.28.5, babel-preset-solid ^1.9.9, esbuild-plugin-babel ^0.2.3

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)
### Build: PASSED

## 2026-01-17 - impl-038: Create TUI state store with SolidJS signals

### Completed
- Created `src/tui/state/store.ts` with comprehensive reactive state management
- Implemented SolidJS signals for all TUI state: logs, currentTask, isPaused, progress, inputHistory, currentPrd
- Added derived state via createMemo: progressPercentage, hasPendingTasks, statusText, nextTask

### State Signals
- `logs` - Array of LogEntry with level, message, timestamp, optional source
- `currentTask` - Current task being worked on (id, title, description, startedAt)
- `isPaused` - Whether Ralph loop is paused
- `progress` - { completed, total, iteration, maxIterations }
- `inputHistory` - Command history for up/down arrow navigation
- `currentPrd` - The loaded PRD object
- `currentPrdFile` - Filename of the loaded PRD
- `autoScroll` - Whether log pane auto-scrolls
- `isRunning` - Whether TUI is running

### Actions Implemented
- Log management: addLog, addLogs, clearLogs (with 500 line limit)
- Task management: startTask, completeTask, skipTask
- Pause control: pause, resume, togglePause
- Progress tracking: updateProgressFromPrd, incrementIteration, setMaxIterations, resetIteration
- Input history: addToHistory, getHistoryCommand (100 entry limit)
- PRD management: loadPrd, updatePrd, unloadPrd
- TUI lifecycle: start, stop, reset

### Technical Details
- Uses SolidJS batch() for atomic multi-signal updates
- Proper handling of exactOptionalPropertyTypes for optional fields
- MAX_LOGS = 500 to prevent memory/CPU issues
- MAX_INPUT_HISTORY = 100 for command recall
- LogEntry levels: info, warn, error, success, debug, stdout, stderr
- Store exported as const object for consistent API

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-17 - impl-039: Create LogPane component with virtualized scrolling

### Completed
- Created `src/tui/components/LogPane.tsx` with full log pane implementation using OpenTUI
- Uses OpenTUI ScrollBox for scrollable log output
- Integrates with TUI state store for reactive updates

### Features
- **LogPane component**: Main scrollable log output pane
  - Uses `@jsxImportSource @opentui/solid` pragma for OpenTUI JSX types
  - Scrollbox with stickyScroll=true and stickyStart="bottom" for auto-scroll
  - Viewport culling for performance
  - Log entries limited to 500 (enforced by store)
  - Auto-scroll indicator when scroll is paused

- **LogEntryRow component**: Renders individual log entries
  - Level-based color coding: error (red), warn (yellow), success (green), info (blue), debug (gray), stdout (white), stderr (light red)
  - Optional timestamps display (HH:MM:SS format)
  - Optional source display (e.g., [claude], [system], [user])
  - Level prefix indicators: [ERR], [WRN], [OK], [INF], [DBG]

- **LogPaneWithControls component**: LogPane with keyboard shortcut hints
  - Shows [C]lear | [A]uto-scroll controls footer

### Props Interface
- `height?: number | \`${number}%\`` - Fixed height (defaults to flex: 1)
- `showTimestamps?: boolean` - Show timestamps (default: true)
- `showSource?: boolean` - Show log source (default: true)
- `borderColor?: string` - Border color as hex string (default: "#444444")
- `title?: string` - Pane title (default: "Logs")

### Technical Details
- Uses OpenTUI's ScrollBoxRenderable for programmatic scrollTo()
- Colors as hex strings (e.g., "#ff5555") per OpenTUI RGBA/ColorInput types
- Border set with border={true} and borderStyle="single" (not { all: "single" })
- createEffect for auto-scroll when logs update
- process.nextTick() ensures layout updates before scrolling
- Proper TypeScript types with ScrollBoxRenderable ref

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)
### Build: PASSED

## 2026-01-17 - impl-040: Create StatusBar component

### Completed
- Created `src/tui/components/StatusBar.tsx` with full status bar implementation using OpenTUI
- Integrates with TUI state store for reactive updates

### Features
- **StatusBar component**: Main status bar with task, progress, and state display
  - Uses `@jsxImportSource @opentui/solid` pragma for OpenTUI JSX types
  - Shows current task ID and title with elapsed time
  - Progress bar with percentage and X/Y count
  - Iteration count (iter X/Y)
  - Status indicator: RUNNING (green), PAUSED (yellow), STOPPED (gray)
  - Configurable border and background colors

- **CompactStatusBar component**: Single-line minimal variant
  - Shows essential info in one line: [STATUS] taskId | X/Y (pct%) | iter X/Y
  - Useful for space-constrained layouts

- **StatusBarWithPrd component**: StatusBar with PRD info header
  - Shows PRD name and filename above the main status bar
  - Uses partial borders (top/left/right) for visual connection

### Helper Functions
- `getStatusColor(status)` - Returns color based on RUNNING/PAUSED/STOPPED state
- `getProgressColor(percentage)` - Returns color gradient based on completion percentage
- `formatElapsedTime(startedAt)` - Formats time as "Xh Ym", "Xm Ys", or "Xs"
- `buildProgressBar(percentage, width)` - Creates text-based progress bar with █ and ░ characters

### Technical Details
- Uses createMemo for computed values (progressText, iterationText, taskText, progressBar)
- Conditionally builds box props to satisfy exactOptionalPropertyTypes
- Colors as hex strings (e.g., "#55ff55") per OpenTUI RGBA/ColorInput types
- Uses backgroundColor (not bg) per OpenTUI BoxOptions interface
- Border sides can be specified as array: ["top", "left", "right"]

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)
## 2026-01-18 - impl-041: Create InputBar component with command input

### Completed
- Created `src/tui/components/InputBar.tsx` with full command input implementation using OpenTUI
- Uses OpenTUI Input element for keyboard capture (not Textarea as originally planned - Input is simpler for single-line commands)
- Integrates with TUI state store for history and pause state

### Features
- **InputBar component**: Main command input with full functionality
  - Uses `@jsxImportSource @opentui/solid` pragma for OpenTUI JSX types
  - Submit on Enter via onSubmit handler
  - History navigation with up/down arrows (navigates through store.inputHistory)
  - Saves current input when navigating back in history, restores on down arrow past index 0
  - Visual feedback for slash commands with color coding:
    - Control commands (pause, resume, skip, abort): Yellow
    - PRD modification commands (issue, note, priority): Cyan
    - Info commands (status, help): Green
    - Invalid commands: Red
  - Valid command indicator in hint bar
  - Prompt color reflects state: Green (active), Yellow (paused), Gray (disabled)
  - Escape key clears input

- **InputBarWithSuggestions component**: InputBar with command autocomplete dropdown
  - Shows filtered command suggestions when typing "/" without space
  - Displays up to 5 matching commands
  - Available commands: issue, pause, resume, skip, status, note, priority, abort, help, clear

- **CompactInputBar component**: Minimal single-line variant
  - No border, single row height
  - Prompt + input display only
  - Suitable for space-constrained layouts

### Props Interface
- `onSubmit?: (input: string) => void` - Callback when command is submitted
- `placeholder?: string` - Placeholder text when empty
- `borderColor?: string` - Custom border color (hex string)
- `bgColor?: string` - Custom background color
- `disabled?: boolean` - Whether input is disabled
- `prompt?: string` - Prompt prefix (default: ">")

### Technical Details
- Uses OpenTUI's InputRenderable (not TextareaRenderable) for simpler single-line input
- Hidden input element positioned off-screen captures keyboard events
- Visual display uses separate text elements for colored command preview
- onKeyDown handler receives KeyEvent from @opentui/core
- onSubmit receives the value directly from Input component
- History index -1 means "not navigating history"
- createMemo for parsed input, command colors, and validation status
- createEffect for auto-focus on mount

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-042: Create main TUI App component and entry point

### Completed
- Created `src/tui/App.tsx` with full TUI application layout using OpenTUI + SolidJS
- Created `src/tui/index.tsx` with TUI entry point, start/stop functions, and convenience APIs

### Features - App.tsx
- **App component**: Main TUI layout with flexbox structure
  - Uses `@jsxImportSource @opentui/solid` pragma for OpenTUI JSX types
  - Header with optional title (hidden in compact mode)
  - LogPane (flex: 1) - scrollable log output
  - StatusBar - current task and progress display
  - InputBar - command input with suggestions
  - Footer with keyboard shortcuts (hidden in compact mode)
  - Responsive layout: compact mode for terminals < 20 rows or < 60 cols
- **MinimalApp component**: Streamlined variant for simple use cases
- **FullApp component**: All features enabled variant
- **useGlobalKeyboard hook**: Global keyboard shortcut handler
  - Ctrl+C: Abort/Exit
  - Ctrl+P: Pause/Resume toggle
  - Ctrl+L: Clear logs
  - Ctrl+A: Toggle auto-scroll
- **AppProps interface**: Configuration with exactOptionalPropertyTypes support

### Features - index.tsx (Entry Point)
- **startTui(options)**: Start the TUI with full configuration
  - Accepts PRD, maxIterations, debug mode, all AppProps
  - Returns TuiInstance with stop(), store, exitPromise
  - Handles exactOptionalPropertyTypes by building props conditionally
- **startMinimalTui(onCommand)**: Start minimal TUI variant
- **stopTui()**: Stop and cleanup the TUI
- **isTuiRunning()**: Check if TUI is currently running
- **Convenience functions**: tuiLog, tuiStartTask, tuiCompleteTask, tuiSkipTask, tuiPause, tuiResume, tuiLoadPrd, tuiUpdatePrd, tuiIncrementIteration, tuiClearLogs
- **Re-exports**: All components, store, and types for external use

### Technical Details
- Uses `render()` from @opentui/solid (returns Promise<void>, not renderer instance)
- `useKeyboard(callback)` takes callback directly (not event emitter pattern)
- `useTerminalDimensions()` returns Accessor<{width, height}> for reactive resize handling
- KeyEvent type imported from @opentui/core for type-safe keyboard handling
- File renamed from index.ts to index.tsx for JSX support
- Props built conditionally to satisfy exactOptionalPropertyTypes
- Exit promise pattern for controlled TUI shutdown

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-043: Implement slash command parser

### Completed
- Created `src/tui/commands/types.ts` with comprehensive type definitions for slash commands
- Created `src/tui/commands/parser.ts` with full command parsing implementation
- Created `src/tui/commands/index.ts` for module exports

### Features - types.ts
- **CommandName type**: Union of all supported command names (issue, pause, resume, skip, status, note, priority, abort, help, clear)
- **CommandCategory type**: Categories for grouping (control, prd, info, system)
- **ParsedCommand interface**: Complete parsed result with isCommand, name, rawArgs, args array, isValid, category
- **CommandDefinition interface**: Metadata including usage, description, examples, arg requirements
- **Command-specific args interfaces**: IssueCommandArgs, NoteCommandArgs, PriorityCommandArgs, SkipCommandArgs, AbortCommandArgs, StatusCommandArgs
- **CommandResult interface**: Execution result with success, message, error, data
- **ParseError interface**: Error info with type, message, command, usage

### Features - parser.ts
- **COMMAND_DEFINITIONS**: Complete definitions for all 10 commands with usage, examples, arg limits
- **VALID_COMMAND_NAMES**: Array of valid command names
- **getCommandCategory()**: Get category from command name
- **isValidCommand()**: Type guard for command validation
- **getCommandDefinition()**: Get full definition by name
- **tokenize()**: Parse input respecting quoted strings (single and double quotes)
- **parseCommand()**: Main parser function extracting name, rawArgs, args array
- **validateCommand()**: Validate arg count against command requirements
- **parseAndValidate()**: Combined parse + validate in one call
- **Command-specific parsers**: parseIssueArgs, parseNoteArgs, parsePriorityArgs, parseSkipArgs, parseAbortArgs, parseStatusArgs
- **getCategoryColor()**: Get hex color for UI styling (yellow=control, cyan=prd, green=info, magenta=system)
- **getHelpText()**: Generate help text for one or all commands grouped by category
- **getCommandSuggestions()**: Get matching commands for autocomplete
- **formatCommandResult()**: Format command result for display

### Technical Details
- Proper handling of exactOptionalPropertyTypes for optional args
- Task ID pattern matching for /note command (impl-XXX, us-XXX, review-XXX)
- Flag parsing for /abort (--force, -f) and /status (-v, --verbose)
- Unlimited args (-1 maxArgs) for description/reason commands
- Re-exports all types from types.ts for single import point

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-044: Implement PRD manager for CRUD operations

### Completed
- Created `src/ralph/prd-manager.ts` with comprehensive PRD management functionality
- Supports both standard UserStory format and extended implementation_tasks format
- Auto-save with configurable debounce (default 500ms)

### Features
- **PrdManager class**: Main class for CRUD operations
  - `load(filePath)` - Load PRD from JSON file
  - `save()` - Save PRD with pretty formatting
  - `flush()` - Force immediate save, clearing debounce timer
  - `isDirty()` - Check if changes are pending save

- **Task Retrieval**:
  - `getAllTasks()` - Get all tasks (implementation_tasks or userStories)
  - `getTask(id)` - Get task by ID
  - `getNextTask()` - Get next pending task with highest priority
  - `getPendingTasks()` - Get all pending tasks
  - `getCompletedTasks()` - Get all completed tasks

- **Progress Tracking**:
  - `getProgress()` - Get progress statistics (total, completed, remaining, percentage)
  - `isComplete()` - Check if PRD is complete

- **CRUD Operations**:
  - `addIssue(options)` - Add new task with auto-generated ID
  - `updateNote(options)` - Update task note with timestamp, optional append mode
  - `updatePriority(options)` - Update task priority/phase
  - `markComplete(taskId)` - Mark task as completed with timestamp
  - `markSkipped(taskId, reason?)` - Mark task as skipped with reason note
  - `startTask(taskId)` - Mark task as in_progress with start timestamp
  - `updateStatus(status)` - Update overall PRD status

- **Review Tasks**:
  - `getReviewTasks()` - Get all review tasks
  - `getPendingReviewTasks()` - Get pending review tasks
  - `updateReviewFinding(id, finding, actionRequired?)` - Update review task finding

- **Static Helpers**:
  - `PrdManager.fileExists(path)` - Check if file exists
  - `PrdManager.findPrdFiles(dir)` - Find PRD files in directory
  - `PrdManager.create(name, description, dir?)` - Create new PRD file

- **Singleton Support**:
  - `getDefaultPrdManager()` - Get singleton instance
  - `resetDefaultPrdManager()` - Reset singleton (for testing)

### Technical Details
- Uses `| null` pattern instead of `| undefined` for exactOptionalPropertyTypes compliance
- ID generation uses same prefix as existing tasks (e.g., `impl-057` continues from `impl-056`)
- Notes include ISO timestamp prefix: `[2026-01-18 00:18:45] Note text`
- Supports both `review_tasks` and `reviewTasks` property names
- Triggers `onUpdate` callback after each mutation for TUI integration
- Cleanup via `destroy()` method flushes pending saves

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-045: Implement /issue command handler

### Completed
- Created `src/tui/commands/issue.ts` with full /issue command implementation
- Integrates with PrdManager for task creation
- Integrates with TUI store for logging and progress updates

### Features
- **executeIssueCommand(options)**: Main execution function
  - Accepts raw input string or pre-parsed IssueCommandArgs
  - Uses PrdManager singleton by default (can override)
  - Auto-generates task ID based on existing pattern (impl-XXX or US-XXX)
  - Supports optional priority/phase override
  - Updates store progress after adding task
  - Logs success/error to TUI log pane

- **handleIssueCommand(input)**: Convenience function for raw command handling

- **createIssue(description, options)**: Programmatic issue creation
  - Direct API for creating issues without command parsing

- **validateIssueInput(input)**: Pre-validation for UI
  - Validates input without executing
  - Returns parsed args if valid
  - Useful for input field validation before submission

- **getIssueHelp()**: Returns help text for the command

### Technical Details
- Handles exactOptionalPropertyTypes by conditionally building result objects
- Parses description from rawArgs (supports quoted strings via parser)
- Uses PrdManager.addIssue() which handles both implementation_tasks and userStories formats
- Updates TUI store progress via setProgress() after successful creation
- All errors logged to store with "error" level for TUI display

### Updated Exports
- Added exports to src/tui/commands/index.ts:
  - executeIssueCommand, handleIssueCommand, createIssue, validateIssueInput, getIssueHelp
  - IssueCommandOptions type

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-046: Implement /pause and /resume command handlers

### Completed
- Created `src/tui/commands/pause.ts` with full pause/resume command implementation
- Integrates with TUI store for isPaused signal management
- Both commands log status changes to TUI log pane

### Features
- **executePauseCommand(options)**: Main /pause execution function
  - Validates input if provided as raw string
  - Checks if already paused (returns success with alreadyPaused flag)
  - Checks if TUI is running (returns error if not)
  - Calls store.pause() which sets isPaused signal and logs status
  - Returns helpful message: "Ralph loop paused. Use /resume to continue."

- **executeResumeCommand(options)**: Main /resume execution function
  - Validates input if provided as raw string
  - Checks if already running (returns success with alreadyRunning flag)
  - Calls store.resume() which clears isPaused signal and logs status
  - Returns message: "Ralph loop resumed"

- **handlePauseCommand(input)**: Convenience for raw /pause command
- **handleResumeCommand(input)**: Convenience for raw /resume command
- **pauseRalph(showInLogs)**: Programmatic pause without parsing
- **resumeRalph(showInLogs)**: Programmatic resume without parsing
- **togglePause(showInLogs)**: Toggle between pause/resume states
- **isPaused()**: Check current pause state
- **getPauseHelp()**: Help text for /pause command
- **getResumeHelp()**: Help text for /resume command

### Technical Details
- Commands integrate with existing store.pause() and store.resume() functions
- Status changes logged to TUI with appropriate levels (warn for pause, info for resume)
- showInLogs option allows silent operation for programmatic use
- Engine will check store.isPaused() between iterations to honor pause state
- Proper error handling for edge cases (already paused, not running)

### Updated Exports
- Added exports to src/tui/commands/index.ts:
  - executePauseCommand, executeResumeCommand, handlePauseCommand, handleResumeCommand
  - pauseRalph, resumeRalph, togglePause, isPaused, getPauseHelp, getResumeHelp
  - PauseCommandOptions type

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-047: Implement /skip command handler

### Completed
- Created `src/tui/commands/skip.ts` with full /skip command implementation
- Integrates with PrdManager for marking tasks as skipped in PRD
- Integrates with TUI store for updating current task and progress

### Features
- **executeSkipCommand(options)**: Main /skip execution function
  - Validates input if provided as raw string
  - Checks for current task (returns error if none)
  - Checks for loaded PRD (returns error if none)
  - Calls PrdManager.markSkipped() which adds timestamped skip note
  - Calls store.skipTask() to clear current task in TUI
  - Updates store progress from PRD manager
  - Logs success/error to TUI log pane

- **handleSkipCommand(input)**: Convenience for raw /skip command
- **skipCurrentTask(reason, options)**: Programmatic skip without parsing
- **validateSkipInput(input)**: Pre-validation for UI
  - Validates input without executing
  - Returns parsed args if valid
  - Useful for input field validation before submission
- **getSkipHelp()**: Returns help text for the command

### Technical Details
- Handles exactOptionalPropertyTypes by conditionally building result objects
- Parses optional reason from rawArgs (supports multiple words, quoted strings)
- Uses PrdManager.markSkipped() which handles both implementation_tasks and userStories formats
- Skip note includes timestamp: "[2026-01-18 00:27:45] Skipped by user: reason"
- Updates TUI store progress via setProgress() after successful skip
- All errors logged to store with "error" level for TUI display

### Updated Exports
- Added exports to src/tui/commands/index.ts:
  - executeSkipCommand, handleSkipCommand, skipCurrentTask, validateSkipInput, getSkipHelp
  - SkipCommandOptions type

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-048: Implement /status command handler

### Completed
- Created `src/tui/commands/status.ts` with full /status command implementation
- Integrates with PrdManager for progress and task details retrieval
- Integrates with TUI store for current task info and logging
- Read-only command that does not modify the PRD

### Features
- **executeStatusCommand(options)**: Main /status execution function
  - Validates input if provided as raw string
  - Retrieves progress from PRD manager (total, completed, pending, percentage)
  - Gets current task from TUI store with elapsed time
  - Supports optional task ID for detailed task info
  - Supports -v/--verbose flag for review task summary
  - Formats output with progress bar and structured display
  - Logs status to TUI log pane

- **handleStatusCommand(input)**: Convenience for raw /status command
- **getStatus(options)**: Programmatic status retrieval without parsing
  - Returns StatusInfo object or null if no PRD loaded
- **validateStatusInput(input)**: Pre-validation for UI
  - Validates input without executing
  - Returns parsed args if valid
- **getStatusHelp()**: Returns help text for the command

### StatusInfo Interface
- prdName, prdStatus: PRD identification
- total, completed, pending, inProgress: Task counts
- percentage: Completion percentage
- currentTask: Optional current task with id, title, status, elapsedTime
- taskDetails: Optional specific task details (if task ID provided)
- reviewSummary: Optional review tasks summary (verbose mode)

### Display Format
- Bordered header with PRD name and status
- Text-based progress bar with percentage
- Completed/pending/in-progress counts
- Current task section with elapsed time
- Task details section (if specific task requested)
- Review summary section (verbose mode only)

### Technical Details
- Handles exactOptionalPropertyTypes by conditionally building result objects
- Supports both ImplementationTask and UserStory formats via type guards
- formatElapsedTime() converts startedAt timestamps to human-readable format
- buildProgressBar() creates text-based progress visualization
- All errors logged to store with appropriate levels

### Updated Exports
- Added exports to src/tui/commands/index.ts:
  - executeStatusCommand, handleStatusCommand, getStatus, validateStatusInput, getStatusHelp
  - StatusCommandOptions, StatusInfo types

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-049: Implement /note command handler

### Completed
- Created `src/tui/commands/note.ts` with full /note command implementation
- Integrates with PrdManager for updating task notes
- Integrates with TUI store for current task retrieval and logging

### Features
- **executeNoteCommand(options)**: Main /note execution function
  - Validates input if provided as raw string
  - Checks for loaded PRD (returns error if none)
  - Supports optional task ID to specify which task to add note to
  - If no task ID provided, uses current task from store
  - Appends note with timestamp to task's notes field
  - Logs success/error to TUI log pane

- **handleNoteCommand(input)**: Convenience for raw /note command
- **addNote(content, options)**: Programmatic note addition with options
  - Supports taskId, append, and prdManager options
- **addNoteToCurrentTask(content, append)**: Simple helper for current task notes
- **validateNoteInput(input)**: Pre-validation for UI
  - Validates input without executing
  - Returns parsed args if valid
  - Useful for input field validation before submission
- **getNoteHelp()**: Returns help text for the command

### Usage Examples
- `/note User requested this feature` - Adds note to current task
- `/note impl-045 Blocked by API rate limits` - Adds note to specific task
- `/note "Multiple words in quotes work too"` - Supports quoted content

### Technical Details
- Handles exactOptionalPropertyTypes by conditionally building options objects
- Uses parseNoteArgs() which detects task ID patterns (impl-XXX, us-XXX, review-XXX)
- Notes are appended with timestamp: `[2026-01-18 00:34:15] Note content`
- Default append=true to preserve existing notes
- All errors logged to store with "error" level for TUI display

### Updated Exports
- Added exports to src/tui/commands/index.ts:
  - executeNoteCommand, handleNoteCommand, addNote, addNoteToCurrentTask, validateNoteInput, getNoteHelp
  - NoteCommandOptions type

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-050: Implement /priority command handler

### Completed
- Created `src/tui/commands/priority.ts` with full /priority command implementation
- Integrates with PrdManager for updating task priority/phase
- Integrates with TUI store for logging and progress updates

### Features
- **executePriorityCommand(options)**: Main /priority execution function
  - Validates input if provided as raw string
  - Checks for loaded PRD (returns error if none)
  - Validates task exists (returns error if not found)
  - Validates priority is a valid integer
  - Calls PrdManager.updatePriority() which updates phase (implementation_tasks) or priority (userStories)
  - Logs success with old and new values
  - Updates store progress after change

- **handlePriorityCommand(input)**: Convenience for raw /priority command
- **changePriority(taskId, priority, options)**: Programmatic priority change
- **validatePriorityInput(input)**: Pre-validation for UI
  - Validates input without executing
  - Returns parsed args if valid
  - Validates priority is an integer
- **getPriorityHelp()**: Returns help text for the command

### Usage Examples
- `/priority impl-044 1` - Move task to phase 1 (highest priority)
- `/priority US-001 5` - Set user story priority to 5
- `/priority impl-050 2` - Move impl-050 to phase 2

### Technical Details
- Handles exactOptionalPropertyTypes by conditionally building result objects
- Uses parsePriorityArgs() which extracts taskId and priority number
- Lower numbers = higher priority (processed first)
- For implementation_tasks: updates the 'phase' field
- For userStories: updates the 'priority' field
- Changes affect which task is selected next by getNextTask()
- All errors logged to store with "error" level for TUI display

### Updated Exports
- Added exports to src/tui/commands/index.ts:
  - executePriorityCommand, handlePriorityCommand, changePriority, validatePriorityInput, getPriorityHelp
  - PriorityCommandOptions type

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18 - impl-051: Implement Claude runner with output streaming

### Completed
- Created `src/ralph/claude-runner.ts` with full Claude Code execution support
- Runs `docker sandbox run claude` via execa with real-time output streaming
- Streams stdout/stderr to TUI log pane with level detection
- Detects completion promise for loop termination

### Features
- **ClaudeRunner class**: Main class for running Claude with streaming output
  - Configurable options: useDocker, permissionMode, provider, model, timeout
  - Builds command arguments for docker sandbox or native claude CLI
  - Streams output line-by-line to TUI store with log level detection
  - Detects completion promise (`<promise>COMPLETE</promise>`)
  - Event-based API: stdout, stderr, start, complete, completionDetected, error
  - Kill support with signal parameter (SIGTERM default)

- **Log Level Detection**:
  - error: Lines containing "error" or "failed"
  - warn: Lines containing "warn"
  - success: Lines containing "success", "completed", or "✓"
  - debug: Lines containing "debug"
  - stdout/stderr: Default levels based on stream

- **Convenience Functions**:
  - `runClaude(options)` - Run Claude and return result
  - `runRalphIteration(options)` - Run a single Ralph loop iteration
  - `isDockerSandboxAvailable()` - Check if docker sandbox is available
  - `isDockerRunning()` - Check if Docker daemon is running
  - `isClaudeCliAvailable()` - Check if native claude CLI exists
  - `detectExecutionMode()` - Detect best execution mode

- **Singleton Support for TUI**:
  - `getActiveRunner()` - Get currently running instance
  - `runClaudeTracked(options)` - Run and track as active runner
  - `killActiveRunner(signal)` - Kill the active runner
  - `hasActiveRunner()` - Check if there's an active runner

### ClaudeRunResult Interface
- success: boolean - Whether run completed successfully
- output: string - Full output from Claude
- completionDetected: boolean - Whether completion promise was found
- exitCode: number | null - Process exit code
- durationMs: number - Duration in milliseconds
- killed: boolean - Whether process was killed
- signal?: string - Signal that killed process
- error?: string - Error message if failed

### Technical Details
- Uses execa v9 with buffer: false for streaming
- Handles exactOptionalPropertyTypes by using class properties instead of options object
- Proper TypeScript typing for execa result shape
- Supports both Anthropic (default) and OpenAI providers
- Permission modes: default, acceptEdits, full
- Timeout support with automatic cancellation
- Environment variable passthrough support

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)

## 2026-01-18T01:44:02+01:00
PRD COMPLETED after 18 iterations

## 2026-01-18 - impl-052: Implement Ralph engine (port bash logic to TypeScript)

### Completed
- Verified existing `src/ralph/engine.ts` implementation is complete and functional
- Fixed TypeScript errors related to exactOptionalPropertyTypes
- Fixed PrdManager instantiation to use constructor with callback instead of accessing private field
- Fixed convertTasksToStories to build UserStory objects conditionally for optional properties
- Removed unused imports (getDefaultPrdManager, ExtendedPrd)

### Features - RalphEngine Class
- Core loop that gets next task, runs Claude iteration, checks completion, updates PRD
- Respects pause flag between iterations via waitForResume() method
- Emits events for UI updates: start, iterationStart, iterationComplete, taskStart, taskComplete, prdComplete, pause, resume, stop, error, progress
- Handles max iterations with configurable limit (default: 10)
- Supports both Docker sandbox and native Claude CLI execution modes
- Loads and manages PRD files via PrdManager
- Initializes and appends to progress file
- Converts implementation_tasks to userStories format for TUI store compatibility

### Configuration Options (RalphEngineOptions)
- prdFile: Path to PRD file (required)
- progressFile: Progress log file path (default: .agents/tasks/progress.txt)
- maxIterations: Max iterations (default: 10)
- provider: AI provider (anthropic/openai)
- model: Model to use
- useDocker: Whether to use Docker sandbox (default: true)
- permissionMode: Claude Code permission mode
- completionPromise: String to detect completion
- iterationTimeout: Timeout per iteration
- logToStore: Whether to log to TUI store (default: true)
- Callbacks: onIterationComplete, onTaskStart, onTaskComplete, onPrdComplete, onStop
- verbose: Enable verbose logging

### Control Methods
- run(): Start the Ralph engine loop, returns RalphEngineResult
- pause(): Pause after current iteration
- resume(): Resume from paused state
- abort(): Stop as soon as possible, kills active Claude runner
- stop(): Graceful stop

### Convenience Functions
- runRalphEngine(options): Run engine with given options
- runSingleIteration(options): Run single iteration without full engine
- canRunRalph(): Check if Ralph can run (Docker/Claude available)

### Singleton Support for TUI
- getActiveEngine(): Get active engine instance
- startRalphEngine(options): Start and track as active
- pauseRalphEngine(): Pause active engine
- resumeRalphEngine(): Resume active engine
- abortRalphEngine(): Abort active engine
- hasActiveEngine(): Check if engine exists
- isEngineRunning(): Check if engine is running
- isEnginePaused(): Check if engine is paused

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)
## 2026-01-18T11:54:44+01:00
PRD COMPLETED after 1 iterations

## 2026-01-18 - impl-053: Integrate TUI with ralph command

### Completed
- Updated `src/commands/ralph.ts` with full TUI mode integration
- Added `--tui` flag (default: true) and `--no-tui` flag for backward compatibility
- Implemented `runTuiMode()` function that:
  - Starts the TUI with PRD info, title, and max iterations
  - Handles slash commands via `handleTuiCommand()` function
  - Integrates with RalphEngine via `startRalphEngine()`
  - Handles Ctrl+C gracefully with signal handlers
  - Displays startup messages and completion/error results
  - Cleans up TUI and listeners on exit

### Features
- **Command Routing**: Routes slash commands to appropriate handlers:
  - /issue → handleIssueCommand
  - /pause → handlePauseCommand + pauseRalphEngine
  - /resume → handleResumeCommand + resumeRalphEngine
  - /skip → handleSkipCommand
  - /status → handleStatusCommand
  - /note → handleNoteCommand
  - /priority → handlePriorityCommand
  - /abort → abortRalphEngine
  - /help → displays help text
  - /clear → clears logs
- **Engine Integration**: Uses RalphEngineOptions callbacks:
  - onIterationComplete (verbose logging)
  - onTaskStart (log task starting)
  - onTaskComplete (log task completion)
  - onPrdComplete (log PRD completion)
  - onStop (log stop reason)
- **Backward Compatibility**:
  - AFK mode (`--afk`) always uses simple spinner mode (no TUI)
  - `--no-tui` reverts to legacy interactive mode
  - Intro/outro banners only shown for non-TUI modes

### Technical Details
- Imports TUI functions: startTui, stopTui, tuiLog
- Imports engine functions: startRalphEngine, abortRalphEngine, pauseRalphEngine, resumeRalphEngine
- Imports command handlers from tui/commands/index.js
- Imports store from tui/state/store.js for /clear command
- Resolves full PRD path based on AGENTS_TASKS_DIR
- Waits 2 seconds after completion for user to see result before exiting

### Type check: PASSED
### Tests: 401 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e)
## 2026-01-18T12:29:05+01:00
PRD COMPLETED after 1 iterations

## 2026-01-18 - impl-054: Write unit tests for command parser

### Completed
- Created `tests/tui/parser.test.ts` with 113 comprehensive unit tests
- Tests cover all exported functions from `src/tui/commands/parser.ts`

### Test Coverage

#### COMMAND_DEFINITIONS (6 tests)
- All 10 command definitions exist with required properties
- Correct categories assigned (prd, control, info, system)
- Correct arg requirements (requiresArgs, minArgs, maxArgs)
- Commands with unlimited args have maxArgs = -1

#### VALID_COMMAND_NAMES (1 test)
- Contains all 10 valid command names

#### Helper Functions (6 tests)
- isValidCommand: Returns true/false for valid/invalid commands
- getCommandCategory: Returns correct category or null
- getCommandDefinition: Returns definition or null

#### tokenize (10 tests)
- Empty string handling
- Simple space-separated args
- Multiple spaces between args
- Double-quoted strings
- Single-quoted strings
- Mixed quotes
- Unclosed quotes
- Complex quoted strings with spaces

#### parseCommand (12 tests)
- Non-command input detection
- Empty and whitespace-only input
- Commands without args
- Commands with simple and quoted args
- Command case insensitivity
- Leading/trailing whitespace trimming
- Unknown command detection
- All 10 valid command types

#### validateCommand (10 tests)
- Non-commands return null
- Unknown commands return error
- Missing required args return error
- Too many args return error
- Valid commands return null
- Unlimited args commands accept many args

#### parseAndValidate (3 tests)
- Combined parse and validate in one call

#### Command-Specific Parsers (28 tests)
- parseIssueArgs: Non-issue, no args, description parsing
- parseNoteArgs: Task ID patterns (impl-XXX, us-XXX, US-XXX, review-XXX), content without ID
- parsePriorityArgs: Arg count validation, numeric validation, negative/zero priority
- parseSkipArgs: Optional reason parsing
- parseAbortArgs: Force flags (--force, -f), reason with force
- parseStatusArgs: Verbose flags (-v, --verbose), taskId parsing

#### UI Helper Functions (11 tests)
- getCategoryColor: Returns correct hex colors for each category
- getHelpText: Specific command help, all commands grouped by category
- getCommandSuggestions: Prefix filtering, empty for non-commands
- formatCommandResult: Success/error formatting

#### Edge Cases (8 tests)
- Command with only spaces after name
- Special characters (#, @) in args
- URLs in args
- Emoji in args
- Newlines in quoted strings
- Tab characters
- Multiple consecutive slashes
- Slash in args

#### Integration Tests (6 tests)
- Complete flow for issue, note, priority, abort, status commands

### Type check: PASSED
### Tests: 514 passed (114 compatibility + 104 filters + 107 scaffolders + 76 e2e + 113 parser)

## 2026-01-18 - impl-055: Write unit tests for PRD manager

### Completed
- Created `tests/tui/prd-manager.test.ts` with comprehensive unit tests for the PRD manager
- 79 tests covering all CRUD operations, auto-save, ID generation, and review tasks

### Test Categories

#### Constructor Tests (3 tests)
- Default options
- Custom saveDebounceMs
- onUpdate callback

#### Load/Save Tests (9 tests)
- Load PRD from file (implementation_tasks and userStories formats)
- Error handling for non-existent files and invalid JSON
- Save PRD with metadata.updatedAt update
- Save error when no PRD loaded
- Auto-save with debounce
- onUpdate callback triggering
- Flush pending saves

#### Task Retrieval Tests (12 tests)
- getAllTasks: implementation_tasks vs userStories
- getTask: Find by ID, non-existent ID
- getNextTask: Sorted by phase/ID, by priority for userStories
- getPendingTasks: pending and in_progress statuses
- getCompletedTasks: completed status filtering

#### Progress Tests (6 tests)
- getProgress: Total, completed, remaining, percentage
- isComplete: All tasks completed, some remaining

#### CRUD Operations Tests (28 tests)
- addIssue: New implementation task, new user story, phase/priority options
- ID generation: Empty PRD, preserve prefix, handle gaps
- updateNote: Add note, append mode, replace mode
- updatePriority: Phase update for impl tasks, priority for stories
- markComplete: Status and passes update, timestamps
- markSkipped: Skip note with and without reason
- startTask: in_progress status, startedAt timestamp
- updateStatus: PRD status update

#### Review Tasks Tests (6 tests)
- getReviewTasks: Return review_tasks array
- getPendingReviewTasks: Filter by status
- updateReviewFinding: Finding and actionRequired update

#### Static Methods Tests (6 tests)
- fileExists: Existing and non-existent files
- findPrdFiles: Find prd-*.json files
- create: Create new PRD file with nested directories

#### Singleton Tests (2 tests)
- getDefaultPrdManager: Singleton pattern
- resetDefaultPrdManager: Reset and create new instance

#### Utility Methods Tests (3 tests)
- getFilename: Return filename only
- destroy: Flush saves and clear state

### Technical Details
- Uses vitest with beforeEach/afterEach for test isolation
- Creates temporary directories in OS tmpdir
- Tests both implementation_tasks and userStories PRD formats
- Verifies auto-save debouncing with timing assertions
- Tests file I/O operations with real filesystem
- Uses vi.fn() for callback testing

### Type check: PASSED
### Tests: 79 passed
## 2026-01-18T13:19:08+01:00
PRD COMPLETED after 3 iterations

## 2026-01-18 - review-001: Verify API key detection approach (Pair Vibe Mode)

### Review Task Completed
- Investigated best approach for detecting ANTHROPIC_API_KEY and OPENAI_API_KEY

### Finding
**Environment variables only** is the correct approach:
1. API keys should NEVER be stored in config files that might be committed to version control
2. Environment variables can be loaded from `.env` files via `dotenv`, `direnv`, or shell sourcing
3. This is the standard pattern used by both Anthropic and OpenAI SDKs
4. The existing `ralph.sh` implementation already follows this pattern correctly
5. Adding config file detection would introduce security risks (accidentally checked-in keys)

### Implementation Notes for src/ralph/api-keys.ts
- Use `process.env.ANTHROPIC_API_KEY` and `process.env.OPENAI_API_KEY`
- Validate key format without making API calls:
  - Anthropic keys: start with `sk-ant-`
  - OpenAI keys: start with `sk-` but NOT `sk-ant-`
- Return structured object with detected providers and validation status

### No action required - finding confirms existing approach is correct

### Type check: PASSED

## 2026-01-18 - review-002: Verify web search implementation options (Pair Vibe Mode)

### Review Task Completed
- Researched web search API options for the Reviewer's look-ahead validation

### Finding

**Recommend Tavily API (primary) with Brave Search API (fallback)**

#### Option Analysis

| Provider | Cost | Rate Limits | Verdict |
|----------|------|-------------|---------|
| **Tavily** | $0.008/credit, 1-2 credits/search | 100 RPM free, 1000 RPM paid | ✅ PRIMARY - designed for AI agents/RAG |
| **Brave** | $5/1000 (~$0.005/search) | 2000 free/mo, 20 QPS paid | ✅ FALLBACK - independent index, privacy-focused |
| SerpAPI | $0.015/request ($75/mo for 5k) | Per-plan limits | ❌ Too expensive, designed for SEO scraping |
| Perplexity Sonar | $1-3/M tokens + $5/1K searches | Token-based | ❌ More expensive, designed for conversational search |
| Browser automation | N/A (infra cost) | N/A | ❌ Too slow (1-3s/page), anti-bot issues |

#### Implementation Recommendations for src/ralph/web-search.ts
1. Use Tavily's `/search` endpoint with basic depth (1 credit per search)
2. Cache results by query hash for 15 minutes to avoid duplicate searches
3. Fallback to Brave Search API if Tavily is rate limited or unavailable
4. Both APIs support structured JSON responses ideal for AI consumption
5. Environment variables: `TAVILY_API_KEY`, `BRAVE_SEARCH_API_KEY`

#### PRD Update
- Updated impl-004 description should reflect "Tavily (primary) with Brave (fallback)" instead of "Tavily (primary) with SerpAPI fallback"

### Type check: PASSED

## 2026-01-18 - review-003: Verify ultrathink implementation

### Completed
- Researched extended thinking/reasoning modes for Claude and OpenAI APIs
- Documented implementation strategy for "ultrathink" consensus mode

### Research Findings

#### Claude Extended Thinking
- **API Parameter**: `thinking: { type: "enabled", budget_tokens: 10000 }`
- **Minimum Budget**: 1,024 tokens
- **Supported Models**: Claude 4 Opus/Sonnet, Claude 3.7 Sonnet
- **Beta Header** (for interleaved thinking): `interleaved-thinking-2025-05-14`
- **Response Format**: Includes `thinking` content blocks with reasoning chain
- **Constraints**: Incompatible with temperature/top_p/top_k modifications; budget_tokens must be < max_tokens (unless using interleaved thinking)

#### OpenAI Reasoning Models (o1, o3, o3-mini)
- **API Parameter**: `reasoning_effort: "low" | "medium" | "high"`
- **Default**: "medium"
- **Performance**: High effort improves accuracy 10-30% but costs more
- **Note**: Chain of thought is hidden (only summarized in response)
- **Best Practice**: Use Responses API for improved performance

#### GPT-4 Fallback (Multi-turn Reflection)
For models without native reasoning support:
1. **Turn 1**: Generate initial proposal
2. **Turn 2**: Critique own proposal ("Review your proposal for flaws, edge cases, and improvements")
3. **Turn 3**: Refine based on critique

#### Implementation Recommendation
Abstract behind `UltrathinkProvider` interface that:
1. Detects model type (Claude extended thinking, OpenAI o-series, or GPT-4 fallback)
2. Applies appropriate strategy automatically
3. Returns normalized response with `reasoning_summary` and `final_proposal` fields

### Sources
- [Claude Extended Thinking Docs](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)
- [AWS Bedrock Extended Thinking](https://docs.aws.amazon.com/bedrock/latest/userguide/claude-messages-extended-thinking.html)
- [OpenAI Reasoning Models](https://platform.openai.com/docs/guides/reasoning)
- [OpenAI reasoning_effort Parameter](https://www.vellum.ai/llm-parameters/reasoning-effort)

### Type check: PASSED

## 2026-01-18 - review-004: Verify concurrent execution safety

### Completed
- Researched Node.js file locking strategies for concurrent PRD updates
- Analyzed proper-lockfile (mkdir-based atomic locking), async-lock (in-process), and write-file-atomic (atomic writes)
- Reviewed existing PrdManager.save() implementation at src/ralph/prd-manager.ts:133
- Identified that scheduleSave() debounce reduces but doesn't prevent race conditions

### Finding Summary
**Two-layer locking strategy recommended:**
1. **In-process**: Use async-lock for Reviewer/Executor coordination (both are async tasks in same process)
2. **Atomic writes**: Use write-file-atomic for safe file operations (temp file + rename pattern)
3. **Cross-process** (future): proper-lockfile if supporting multiple ralph processes

**Implementation plan:**
- Add async-lock dependency
- Create src/ralph/prd-lock.ts singleton lock manager
- Modify PrdManager.save() to acquire lock before write
- Timeout: 5 seconds, Retries: 3 with exponential backoff (100ms, 200ms, 400ms)

### Sources
- [proper-lockfile - npm](https://www.npmjs.com/package/proper-lockfile)
- [async-lock - npm](https://www.npmjs.com/package/async-lock)
- [write-file-atomic - npm](https://www.npmjs.com/package/write-file-atomic)
- [Understanding Node.js file locking - LogRocket](https://blog.logrocket.com/understanding-node-js-file-locking/)

### Type check: PASSED

## 2026-01-18 - review-005: Verify rate limit handling

### Completed
- Researched Claude API rate limits by tier (1-4): RPM 50-4000, ITPM 30K-2M, OTPM 8K-400K for Sonnet/Opus
- Researched OpenAI API rate limits by tier: ~500 RPM, 30K+ TPM for GPT-4o (tier-dependent)
- Analyzed exponential backoff with jitter strategies (Full Jitter recommended by AWS)
- Documented response headers for both providers for dynamic rate limit tracking

### Finding Summary
**Rate Limits by Provider:**
- **Claude (Tier 1-4)**: RPM 50-4000, ITPM 30K-2M (uncached only), OTPM 8K-400K
- **OpenAI (Tier 1-4)**: RPM ~500-5000, TPM 30K-4M+ (varies significantly by tier)

**Exponential Backoff with Full Jitter:**
```
sleep = random(0, min(cap, base * 2^attempt))
// base: 1s, cap: 60s, max_attempts: 6
```

**Response Headers:**
- Claude: `anthropic-ratelimit-{requests,tokens,input-tokens,output-tokens}-{limit,remaining,reset}`, `retry-after`
- OpenAI: `x-ratelimit-{limit,remaining,reset}-{requests,tokens}`, `retry-after`

**Implementation Recommendations:**
1. Track limits PER PROVIDER independently (Reviewer vs Executor have separate quotas)
2. Respect `retry-after` header from 429 responses
3. Use client-side token bucket to proactively avoid hitting limits
4. Circuit breaker: After 5 consecutive 429s within 60s, open circuit for 2 minutes
5. Graceful degradation: On rate limit exhaustion, continue with single-model mode
6. Leverage Claude's cache-aware ITPM for 5-10x effective throughput

### Sources
- [Claude API Rate Limits](https://platform.claude.com/docs/en/api/rate-limits)
- [OpenAI Rate Limits](https://platform.openai.com/docs/guides/rate-limits)
- [AWS Exponential Backoff and Jitter](https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/)
- [AWS Builders Library - Timeouts, retries and backoff](https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/)

### Type check: PASSED

## 2026-01-18 - review-006: Research sycophancy mitigation

### Completed
- Researched CONSENSAGENT paper (ACL 2025) on dynamic prompt refinement for sycophancy mitigation
- Researched anonymization-based approaches from "Measuring and Mitigating Identity Bias in Multi-Agent Debate"
- Compared implementation complexity and effectiveness of both approaches
- Identified Identity Bias Coefficient (IBC) as a diagnostic metric

### Finding Summary
**Recommend SIMPLER ANONYMIZATION over CONSENSAGENT's dynamic prompt refinement.**

#### Anonymization Approach (Recommended)
- Remove identity markers from consensus prompts so agents cannot distinguish "self" from "peer"
- Present proposals as "Proposal A" and "Proposal B" without attribution
- Research shows dramatic bias reduction (e.g., Qwen-32B IBC dropped from 0.608 to 0.024)
- Requires no model retraining or architectural changes
- Simple to implement: just change prompt labels during consensus phase

#### CONSENSAGENT Approach (More Complex)
- Dynamic prompt refinement based on agent interactions
- Achieves SOTA on benchmark reasoning datasets
- Adds significant implementation complexity (tracking interaction patterns, adjusting prompts)
- Better suited for research settings than production systems

#### Implementation for Pair Vibe Mode
1. **Label proposals neutrally**: "Proposal A/B" not "Claude/OpenAI" or "Executor/Reviewer"
2. **Require explicit reasoning**: Flag suspiciously quick consensus (< 30 seconds)
3. **Minimum reasoning length**: Reject one-line agreements
4. **Detect copying**: Check for verbatim overlap between proposals
5. **Log IBC metric**: `IBC = conformity_rate_vanilla - conformity_rate_anonymized` for diagnostics
6. **Future enhancement**: Consider CONSENSAGENT if anonymization proves insufficient

### Sources
- [CONSENSAGENT - ACL Anthology](https://aclanthology.org/2025.findings-acl.1141/)
- [When Identity Skews Debate: Anonymization for Bias-Reduced Multi-Agent Reasoning](https://arxiv.org/html/2510.07517)
- [Measuring and Mitigating Identity Bias in Multi-Agent Debate via Anonymization](https://openreview.net/forum?id=XxBR2KNWNh)
- [GitHub - llm_multiagent_debate](https://github.com/composable-models/llm_multiagent_debate)

### Type check: PASSED

## 2026-01-18 - review-007: Verify timeout strategy

### Completed
- Researched Claude API timeout best practices and streaming recommendations
- Researched OpenAI API timeout configuration and SDK options
- Analyzed circuit breaker pattern implementations for Node.js (opossum library)
- Designed three-tier timeout strategy for Pair Vibe Mode coordination
- Identified existing timeout patterns in codebase (10min iteration timeout in engine.ts)

### Finding Summary
**THREE-TIER TIMEOUT STRATEGY with circuit breaker pattern:**

#### Tier 1 - Web Search (30s)
- Individual Tavily/Brave API calls timeout at 30s
- After 2 consecutive failures, circuit opens for 60s
- Return cached/empty results when circuit is open

#### Tier 2 - Review Step (2min)
- Total time for Reviewer to complete one step review (search + analysis)
- If exceeded, mark step as 'review_timeout' and let Executor proceed without review
- Log warning for visibility

#### Tier 3 - Reviewer Lag (5 steps)
- If Executor is 5+ steps ahead of Reviewer, pause Executor
- Show 'Waiting for review...' status
- After 2min wait timeout, warn and continue without review for that step

#### Streaming & Idle Timeout
- Use streaming for all LLM calls per Anthropic recommendation (>10min requests)
- 90s idle timeout (no data received) to detect hung streams
- Anthropic SDK issue #867 proposes adding idleTimeout configuration

#### Circuit Breaker Implementation
- Three states: closed (normal), open (failing fast), half-open (testing recovery)
- Failure threshold: 3 consecutive failures
- Reset timeout: 60s before half-open test
- Half-open allows 1 test request before fully closing
- Use opossum library (nodeshift/opossum) for Node.js implementation

#### Fallback Chain
1. Retry with exponential backoff
2. Skip web search (use LLM knowledge only)
3. Skip review for current step
4. Degrade to single-model mode

#### Existing Codebase Patterns
- engine.ts:59 uses 10min iteration timeout - maintain this for Executor
- claude-runner.ts supports configurable timeout via options.timeout
- prd-manager.ts uses debounced save with saveTimeout

### Sources
- [Claude Code Timeout Configuration Guide - GitHub #5615](https://github.com/anthropics/claude-code/issues/5615)
- [Anthropic SDK Streaming Idle Timeout Proposal - GitHub #867](https://github.com/anthropics/anthropic-sdk-typescript/issues/867)
- [Claude Docs - Errors](https://docs.anthropic.com/en/api/errors)
- [OpenAI API Timeout Configuration](https://community.openai.com/t/setting-request-timeout-in-openai-v1-2-2/492772)
- [opossum - Node.js Circuit Breaker](https://github.com/nodeshift/opossum)
- [Circuit Breaker Pattern in Node.js - LogRocket](https://blog.logrocket.com/use-circuit-breaker-node-js/)
- [Google SRE - Addressing Cascading Failures](https://sre.google/sre-book/addressing-cascading-failures/)
- [AWS - Graceful Degradation](https://docs.aws.amazon.com/wellarchitected/latest/reliability-pillar/rel_mitigate_interaction_failure_graceful_degradation.html)

### Type check: PASSED

---

## review-008: Estimate cost multiplier

**Date**: 2026-01-18
**Task**: Calculate expected cost multiplier for Pair Vibe Mode and define UI cost warning

### Findings

#### Current API Pricing (January 2026)

**Anthropic Claude:**
| Model | Input (per M tokens) | Output (per M tokens) |
|-------|---------------------|----------------------|
| Claude Opus 4.5 | $5.00 | $25.00 |
| Claude Sonnet 4.5 | $3.00 | $15.00 |
| Claude Haiku 4.5 | $1.00 | $5.00 |

**OpenAI:**
| Model | Input (per M tokens) | Output (per M tokens) |
|-------|---------------------|----------------------|
| GPT-4o | $2.50 | $10.00 |
| GPT-4.1 | $2.00 | $8.00 |
| o1 (reasoning) | $15.00 | $60.00 |
| o3 (reasoning) | $2.00 | $8.00 |
| o3-mini | $0.55 | $2.20 |

**Web Search (Tavily):**
- Basic search: 1 credit ($0.008)
- Advanced search: 2 credits ($0.016)
- Free tier: 1,000 credits/month

#### Cost Multiplier Analysis

**Pair Vibe Mode Components:**
1. **Executor** (baseline): 1.0x - same as single model mode
2. **Reviewer** (concurrent): +0.6x - runs ahead with fewer output tokens (~40% of Executor since analysis not code generation)
3. **Web Search**: ~$0.008-0.016/step - negligible compared to LLM costs

**Consensus Mode Overhead (when triggered):**
- Both models generate proposals: +0.5x
- Ultrathink round (if needed): +1.5-3x for that specific step
- Average 1.5 rounds per consensus

#### Cost Scenarios

| Scenario | Consensus Rate | Multiplier |
|----------|---------------|------------|
| Low friction | 10% | 2.2x |
| Medium friction | 25% | 2.8x |
| High friction | 40% | 3.5x |

#### Cost Optimization Strategies
1. Use GPT-4.1 or o3 as Reviewer ($2/M input vs $2.50/M for GPT-4o)
2. Leverage Claude prompt caching (90% discount on cached input tokens)
3. Use Batch API for non-urgent consensus (50% discount)
4. Skip web search for well-understood technologies

#### UI Warning Text
```
Pair Vibe Mode runs two models concurrently with independent review.
Expected cost: 2-4x single model. Actual cost depends on how often 
consensus is needed. Proceed?
```

#### Real-time Cost Display
- Show running cost estimate in StatusBar
- Breakdown by model and phase
- Update after each API call

### Sources
- [Anthropic Claude Pricing](https://platform.claude.com/docs/en/about-claude/pricing)
- [OpenAI API Pricing](https://openai.com/api/pricing/)
- [Tavily Credits & Pricing](https://docs.tavily.com/documentation/api-credits)

### Type check: N/A (research task)

## 2026-01-18 - impl-001: Create API key detector utility (Pair Vibe Mode)

### Completed
- Created `src/ralph/api-keys.ts` with API key detection for Pair Vibe Mode
- Detects ANTHROPIC_API_KEY and OPENAI_API_KEY from environment variables
- Validates key format without making API calls:
  - Anthropic: sk-ant-* prefix, minimum 20 chars
  - OpenAI: sk-* prefix (excluding sk-ant-*), minimum 20 chars
- Exported functions: detectApiKeys(), validateApiKey(), hasValidApiKey(), getAvailableProviders(), canEnablePairVibeMode(), getEnvVarName()
- Exported types: ApiProvider, ApiKeyValidation, ApiKeyDetectionResult

### Technical Details
- Follows review-001 findings: environment variables only (no config files for security)
- Standard pattern used by both Anthropic and OpenAI SDKs
- Returns structured result with:
  - availableProviders: list of providers with valid keys
  - validations: detailed validation result per provider
  - canEnablePairVibe: boolean for 2+ providers
  - summary: user-friendly message

### Type check: PASSED
### Tests: 672 PASSED (all existing tests still pass)

## 2026-01-18 - impl-002: Extend UserStory type with review fields

### Completed
- Added `ConsensusRecord` interface to `src/ralph/prd-schema.ts`
  - Fields: executorProposal, reviewerProposal, aligned, finalDecision, decidedBy, rounds, timestamp
  - Optional fields: status ('completed' | 'cancelled' | 'timeout'), notes
  - decidedBy enum: 'consensus' | 'executor' | 'reviewer' | 'user'
- Extended `UserStory` interface with Pair Vibe Mode fields:
  - `findings?: string[] | null` - null=not reviewed, []=clean, [...]= issues found
  - `consensus?: ConsensusRecord | null` - consensus record when findings exist
- Updated `PRD_JSON_SCHEMA` with full validation for new fields
  - findings: array of strings or null
  - consensus: object with required and optional properties, or null

### Technical Details
- All new fields are optional for backwards compatibility
- Existing PRDs without these fields will continue to work
- JSON schema validates decidedBy against enum values
- JSON schema validates status against enum values
- Supports edge-007 (cancelled consensus) via status field

### Type check: PASSED
### Tests: PASSED (672/672)

## 2026-01-18 - impl-003: Create Pair Vibe Mode configuration types

### Completed
- Created `src/ralph/pair-vibe-types.ts` with comprehensive type definitions for Pair Vibe Mode
- Core configuration interfaces:
  - `PairVibeConfig`: Mode configuration with enabled flag, executor/reviewer provider and model assignment, timeouts, and options
  - `DEFAULT_PAIR_VIBE_CONFIG`: Default values (maxLookAhead: 3, reviewTimeout: 2min, consensusTimeout: 5min, maxConsensusRounds: 2)
- State management types:
  - `PairVibePhase`: 'initializing' | 'review' | 'execute' | 'consensus' | 'paused' | 'completed' | 'error'
  - `PairVibeState`: Runtime state with current phase, reviewer/executor progress, step tracking, active consensus session
  - `StepProgress`: Per-step status tracking with timestamps
- Consensus types:
  - `ConsensusSession`: Active consensus state with round tracking, proposals, ultrathink flag
  - `ConsensusProposal`: Individual proposal with anonymized label (A/B per edge-006), content, reasoning
  - `ConsensusResult`: Resolution result with alignment status, decidedBy, rounds, sycophancy detection
- Event system:
  - `PairVibeEvent`: Discriminated union of 20+ event types for phase changes, reviewer/executor progress, consensus, web search, rate limits, circuit breaker, cost updates
  - `PairVibeEventHandler`: Event handler type
- Metrics types:
  - `CostBreakdown`: Cost by executor, reviewer, consensus, web search
  - `PairVibeMetrics`: Session-level metrics with consensus rate, review timeouts, cost breakdown
  - `StepMetrics`: Per-step duration and cost tracking
- Model types:
  - `ClaudeModel`: claude-sonnet-4-20250514, claude-opus-4-20250514, claude-sonnet-4-5-20250514
  - `OpenAIModel`: gpt-4o, gpt-4.1, o1, o3, o3-mini
  - `ModelIdentifier`: Union of both
- Helper functions:
  - `createInitialPairVibeState()`: Factory for initial state
  - `createStepProgress()`: Factory for step progress
  - `createDefaultPairVibeConfig()`: Create config from detected providers with sensible defaults
  - `checkSycophancyRisk()`: Detect potential sycophancy (fast consensus, high similarity per edge-006)

### Technical Details
- Uses type-only imports per verbatimModuleSyntax
- Imports ApiProvider from api-keys.ts and ConsensusRecord from prd-schema.ts
- All timeout values aligned with review-007 findings
- Sycophancy detection thresholds: <30s consensus, >95% similarity
- Supports all edge cases defined in PRD (edge-001 through edge-010)

### Type check: PASSED
### Tests: 672 PASSED

## 2026-01-18 - impl-004: Create web search service for Reviewer

### Completed
- Created `src/ralph/web-search.ts` with WebSearchService class for Reviewer's web search capabilities
- Dual-provider support per review-002 findings:
  - **Tavily API (primary)**: $0.008/credit, designed for AI agents
  - **Brave Search API (fallback)**: $5/1000 requests, privacy-focused
- Core interfaces:
  - `WebSearchResult`: title, url, snippet, score, publishedDate
  - `WebSearchResponse`: query, results, provider, cached flag, durationMs, error
  - `WebSearchOptions`: maxResults, searchDepth (basic/advanced), domain filters, timeout
- Caching system:
  - 15-minute TTL per review-002 recommendation
  - Cache key based on normalized query hash + options
  - Methods: `clearExpiredCache()`, `clearCache()`, `getCacheStats()`
- Timeout handling per review-007:
  - 30 second default timeout for individual search calls
  - AbortController for fetch cancellation
  - Proper error messages for timeouts
- Event integration:
  - Emits `web-search-started`, `web-search-completed`, `web-search-failed` events
  - Uses PairVibeEvent types from pair-vibe-types.ts
- Query builders for common Reviewer use cases:
  - `searchQueries.bestPractices(tech, context)`: "{tech} best practices {context} 2025"
  - `searchQueries.knownIssues(tech, version?)`: Known bugs and problems
  - `searchQueries.alternatives(approach, goal)`: Alternative approaches comparison
  - `searchQueries.security(tech, operation)`: Security vulnerabilities, OWASP
  - `searchQueries.performance(tech, operation)`: Performance optimization benchmarks
- Helper functions:
  - `createWebSearchService()`: Factory function
  - `isWebSearchAvailable()`: Check if any provider configured

### Technical Details
- Uses native fetch API (no external HTTP dependencies)
- Tavily: POST to api.tavily.com/search with JSON body
- Brave: GET to api.search.brave.com/res/v1/web/search with X-Subscription-Token header
- Properly handles exactOptionalPropertyTypes TypeScript setting
- Environment variables: TAVILY_API_KEY, BRAVE_SEARCH_API_KEY

### Type check: PASSED
### Tests: 672 PASSED

## 2026-01-18 - impl-005: Implement ReviewerRunner class

### Completed
- Created `src/ralph/reviewer-runner.ts` with concurrent step review for Pair Vibe Mode
- Runs ahead of Executor to pre-review future steps
- Uses WebSearchService for technology validation (Tavily primary, Brave fallback)
- Auto-generates search queries based on detected technologies in step content
- Technology detection covers: React, Vue, Angular, Next.js, TypeScript, databases, cloud providers, testing frameworks
- LLM client abstraction (ReviewerLLMClient interface) for provider-agnostic analysis
- Heuristic findings extraction when no LLM client is available

### Technical Details
- ReviewerRunner class extends EventEmitter for UI integration
- State machine: idle → running → paused/waiting_for_consensus → stopped
- MAX_STEPS_AHEAD = 5 to prevent Reviewer from getting too far ahead
- Timeout strategy per review-007:
  - Web search: 30s per call (DEFAULT_SEARCH_TIMEOUT_MS)
  - Review step: 2min total (DEFAULT_REVIEW_TIMEOUT_MS)
- Query generation using searchQueries helpers:
  - bestPractices(tech, context)
  - knownIssues(tech, version)
  - security(tech, operation)
  - performance(tech, operation)
- Emits PairVibeEvents: reviewer-started, reviewer-completed, reviewer-timeout, consensus-started
- pause()/resume()/waitForConsensus()/consensusCompleted() for consensus mode integration
- skipStep() for /reviewer skip command support
- createDefaultReviewerLLMClient() placeholder for testing

### Type check: PASSED
### Tests: All 672 existing tests pass

## 2026-01-18 - impl-006: Implement ConsensusRunner class

### Completed
- Created `src/ralph/consensus-runner.ts` with full consensus orchestration
- Orchestrates consensus resolution when Reviewer finds issues on a step
- Multi-round consensus with configurable max rounds (default 2 per edge-003)
- Anonymized proposals as "Proposal A" and "Proposal B" to prevent sycophancy (per edge-006)
- Ultrathink mode triggers on round 2+ with optional web search grounding
- 5-minute consensus timeout with graceful handling (per impl-006 spec)
- Executor wins tie-breaker after max rounds (per core_philosophy)
- Sycophancy risk detection using checkSycophancyRisk() from pair-vibe-types

### Key Interfaces
- ConsensusLLMClient: Provider-agnostic interface for proposal generation and alignment checking
  - generateProposal(): Generate a proposal for a step given findings
  - checkAlignment(): Check if two proposals are substantially aligned
- ConsensusRunnerOptions: Configuration with executor/reviewer clients, web search, event handler
- ConsensusState: idle | collecting_proposals | checking_alignment | ultrathink | resolved | timeout | cancelled | error

### Features
1. Multi-round consensus loop with timeout protection
2. Parallel proposal collection from executor and reviewer
3. Random A/B label assignment to prevent identity bias
4. Simple Jaccard similarity fallback when no LLM client available
5. Web search grounding during ultrathink mode
6. toConsensusRecord() for converting results to PRD storage format
7. Cancel support per edge-007 for saving partial consensus state
8. PairVibeEvent emission for UI integration:
   - consensus-started, consensus-round, consensus-completed, consensus-timeout

### Helper Functions
- createConsensusRunner(): Factory function
- createDefaultConsensusLLMClients(): Placeholder clients for testing
- needsConsensus(step): Check if step has findings requiring consensus
- hasConsensusRecord(step): Check if step already has consensus resolution

### Type check: PASSED
### Tests: All 672 existing tests pass

## 2026-01-18 - impl-007: Implement ultrathink prompting

### Completed
Created `src/ralph/ultrathink.ts` implementing extended thinking / deep reasoning capabilities
for consensus mode. Provider-agnostic design with automatic strategy selection per model type.

### Implementation Details (per review-003 findings)

#### 1. Claude Extended Thinking
- Uses `thinking` object with `{type: 'enabled', budget_tokens: N}`
- Minimum budget: 1024 tokens, default: 10000 tokens
- Beta header: `anthropic-beta: interleaved-thinking-2025-05-14`
- Model mapping for claude-sonnet-4, claude-opus-4, claude-sonnet-4-5
- Parses thinking and text content blocks from response
- Returns thinking content in metadata when exposed

#### 2. OpenAI O-Series (o1, o3, o3-mini)
- Uses `reasoning_effort` parameter: 'low' | 'medium' | 'high'
- Default: 'high' (improves accuracy 10-30% per review-003)
- Hidden chain of thought (summarized in reasoningSummary)
- Extracts reasoning_tokens from completion_tokens_details
- Uses max_completion_tokens instead of max_tokens

#### 3. GPT-4 Multi-Turn Reflection Fallback
- For gpt-4o and gpt-4.1 (no native extended thinking)
- 3-turn pattern: Generate → Critique → Refine
- Turn 1: Generate initial proposal with context
- Turn 2: "Review your proposal for flaws, edge cases, and improvements"
- Turn 3: Refine based on self-critique
- Returns critique summary in reasoningSummary

### Core Types
- `UltrathinkResult`: Normalized response with finalProposal, reasoningSummary, usedExtendedThinking, model, metadata, tokenUsage, durationMs
- `UltrathinkParams`: Input including step, findings, searchResults, model, timeout, thinkingBudget, reasoningEffort
- `UltrathinkProvider`: Interface with generateProposal() and supportsModel()
- `UltrathinkMetadata`: Provider-specific details (thinkingContent, reasoningEffort, reflectionTurns)
- `UltrathinkTokenUsage`: inputTokens, outputTokens, optional thinkingTokens

### Provider Classes
- `ClaudeUltrathinkProvider`: Extended thinking implementation
- `OpenAIOSeriesUltrathinkProvider`: reasoning_effort implementation
- `GPT4ReflectionProvider`: Multi-turn reflection fallback

### Helper Functions
- `isClaudeModel(model)`: Check if model is claude-*
- `isOpenAIOSeriesModel(model)`: Check if model is o1/o3/o3-mini
- `isGPTModel(model)`: Check if model is gpt-4o/gpt-4.1
- `createUltrathinkProvider(model, config)`: Factory with auto-selection
- `generateUltrathinkProposal(params, config)`: Convenience wrapper
- `supportsExtendedThinking(model)`: Check native thinking support
- `getRecommendedThinkingBudget(model)`: Returns 10000 for Claude, 0 otherwise
- `getRecommendedReasoningEffort(model)`: Returns 'high' for o-series, null otherwise

### Error Handling
- All providers return graceful fallback on API errors
- Timeout via AbortController on all fetch calls
- Error message included in fallback UltrathinkResult

### Integration Points
- Compatible with ConsensusRunner.generateProposal() interface
- Uses WebSearchResponse from web-search.ts for search result formatting
- Uses UserStory from prd-schema.ts for step context
- Uses ModelIdentifier from pair-vibe-types.ts for model type checking

### Type check: PASSED
### Tests: All 672 existing tests pass

## 2026-01-18 - impl-008: Implement PairVibeEngine orchestrator

### Completed
- Created `src/ralph/pair-vibe-engine.ts` with the main Pair Vibe Mode orchestrator
- Implements PairVibeEngine class that coordinates concurrent Reviewer and Executor execution
- Spawns Reviewer as concurrent async task via runReviewerLoop()
- Main Executor loop checks for findings and enters consensus mode when needed
- Full pause/resume/stop controls with graceful state management
- Emits structured PairVibeEvent events for TUI integration

### Features
1. **Concurrent Reviewer Loop**
   - Runs ahead of Executor by configurable maxLookAhead (default 3 steps)
   - Pauses during consensus mode per impl-005
   - Handles timeout gracefully (2 minutes per edge-001)

2. **Main Executor Loop**
   - Checks if step has findings before execution
   - Enters consensus mode when findings.length > 0
   - Waits for review with timeout (proceeds without if needed)
   - Tracks step progress through status lifecycle

3. **Consensus Integration**
   - Pauses Reviewer during consensus
   - Uses ConsensusRunner for multi-round resolution
   - Records consensus results in step.consensus field

4. **Edge Case Handling**
   - edge-001: Wait for review timeout (2 minutes)
   - edge-008: Cap concurrent consensus at 1 (sequential processing)
   - edge-009: Proceed without review when timeout occurs

5. **Metrics Tracking**
   - PairVibeMetrics with session stats
   - StepMetrics per step (review, execution, consensus durations)
   - Average reviewer ahead distance

6. **External Adapters**
   - executeStep callback for existing Ralph engine integration
   - savePrd callback for PRD persistence

### Exports
- `PairVibeEngine` class with full API
- `createPairVibeEngine()` factory function
- `canEnablePairVibeMode()` helper
- `getDefaultPairVibeConfig()` helper
- Types: `PairVibeEngineOptions`, `PairVibeEngineResult`, `ExecuteStepResult`, `EngineState`

### Type check: PASSED
### Tests: PASSED (672/672)

## 2026-01-18 - impl-009: Add Pair Vibe Mode prompt to ralph command

### Completed
- Extended ralph command with Pair Vibe Mode integration
- Added CLI arguments: `--pair-vibe`, `--no-pair-vibe`, `--executor <provider>`, `--reviewer <provider>`
- Implemented `promptPairVibeMode()` function with:
  - API key detection via `detectApiKeys()` from api-keys.ts
  - Interactive prompts for enabling Pair Vibe Mode
  - Executor/Reviewer provider assignment
  - Cost warning display (2-4x multiplier estimates per review-008)
- Created `runPairVibeTuiMode()` function that:
  - Initializes PairVibeEngine with config and event handlers
  - Forwards all PairVibeEvents to TUI with appropriate log sources (reviewer, executor, consensus, search)
  - Implements graceful shutdown on SIGINT/SIGTERM
- Added `showCostWarning()` with breakdown of expected cost multipliers
- Added `getModelDisplayName()` for user-friendly model output

### Technical Details
- Import additions: detectApiKeys, ApiProvider, PairVibeConfig, ModelIdentifier, createDefaultPairVibeConfig, PairVibeEngine, PairVibeEngineOptions
- Extended RalphOptions interface with pairVibe, executorProvider, reviewerProvider fields
- Updated parseRalphArgs to handle new CLI options
- Pair Vibe Mode only available in interactive TUI mode (not AFK)
- Event handler maps all PairVibeEvent types to TUI log calls with appropriate sources and levels

### Type check: PASSED

## 2026-01-18 - impl-010: Add Pair Vibe status to TUI StatusBar

### Completed
- Extended TUI store with Pair Vibe Mode state management
- Added `PairVibeStatus` interface to store with fields: enabled, phase, reviewerAhead, reviewerStep, executorStep, activeConsensus, executorProvider, reviewerProvider
- Added store signals: `pairVibeStatus`, `setPairVibeStatus`
- Added derived memos: `isPairVibeActive`, `pairVibePhaseText`
- Added store actions: `enablePairVibe()`, `disablePairVibe()`, `updatePairVibePhase()`, `updateReviewerProgress()`, `updateExecutorProgress()`, `setActiveConsensus()`

### StatusBar Component Updates
- Added `getPairVibePhaseColor()` helper for phase-specific coloring:
  - REVIEW: purple (#bb88ff)
  - EXEC: blue (#55aaff)
  - CONSENSUS: orange (#ffaa55)
  - PAUSED: yellow (#ffff55)
  - ERROR: red (#ff5555)
  - DONE: green (#55ff55)
  - INIT: gray (#888888)
- Added Pair Vibe indicators to StatusBar JSX:
  - [PAIR VIBE] indicator in magenta (#ff88ff)
  - Phase indicator with color-coding
  - Reviewer progress display (e.g., "Rev: +3 ahead" or "Rev: synced")
  - Consensus round indicator when in consensus mode (e.g., "(R2)")
- Updated `CompactStatusBar` to include Pair Vibe info in compact format

### Test Coverage
- Added 21 new tests for Pair Vibe store functionality:
  - enablePairVibe and disablePairVibe tests
  - updatePairVibePhase tests
  - updateReviewerProgress tests
  - updateExecutorProgress tests
  - setActiveConsensus tests
  - isPairVibeActive memo tests
  - pairVibePhaseText memo tests
  - reset clears Pair Vibe state test
  - getPairVibePhaseColor helper function tests

### Files Modified
- `src/tui/state/store.ts`: Added Pair Vibe state management
- `src/tui/components/StatusBar.tsx`: Added Pair Vibe indicators
- `tests/tui/components.test.ts`: Added Pair Vibe tests

### Type check: PASSED
### Tests: 693/693 PASSED

## 2026-01-18 - impl-011: Add Pair Vibe log formatting to LogPane

### Completed
- Extended `src/tui/components/LogPane.tsx` with Pair Vibe Mode log formatting
- Implemented source-based coloring for Pair Vibe Mode sources
- Added collapsible consensus discussion sections
- Added 36 new tests for all new helper functions

### Implementation Details (per impl-011 requirements)

#### 1. Source-Based Coloring
- `getSourceColor(source)`: Returns color for Pair Vibe sources
  - Executor/Claude: Blue (#55aaff)
  - Reviewer/OpenAI: Purple (#bb88ff)
  - Consensus: Orange (#ffaa55)
  - Search: Dimmed gray (#666666)
  - System: Gray (#888888)
  - Unknown sources: null (fall back to level color)

#### 2. Source Prefixes
- `getSourcePrefix(source)`: Returns prefix for Pair Vibe sources
  - Executor/Claude: [EXE]
  - Reviewer/OpenAI: [REV]
  - Consensus: [CON]
  - Search: [SRC]
  - System: [SYS]
  - Unknown: Truncated uppercase (e.g., [UNK])

#### 3. Pair Vibe Source Detection
- `isPairVibeSource(source)`: Checks if source is a known Pair Vibe source
- Case-insensitive matching for: executor, reviewer, consensus, search, claude, openai

#### 4. Consensus Detection
- `isConsensusStart(entry)`: Detects "consensus started" or "entering consensus" messages
- `isConsensusEnd(entry)`: Detects "consensus completed/reached/timeout" or "executor wins"

#### 5. Consensus Grouping
- `groupLogsWithConsensus(logs, collapsedGroups)`: Groups log entries into:
  - Regular entries: `{ type: 'entry', entry: LogEntry }`
  - Consensus groups: `{ type: 'group', group: ConsensusGroup }`
- ConsensusGroup includes: id, entries, isExpanded, summary
- Summary extracted from end marker: "Consensus reached", "Consensus timeout", "Executor decision"

#### 6. CollapsibleConsensusSection Component
- Shows header with expand/collapse indicator (▶/▼)
- Orange color (#ffaa55) for consensus theme
- Summary text when collapsed (e.g., "▶ [CON] Consensus reached")
- Indented entries when expanded

#### 7. LogPane Updates
- Uses `store.isPairVibeActive` to detect Pair Vibe Mode
- In Pair Vibe Mode: Groups logs with consensus sections, uses source-based coloring
- In normal mode: Standard level-based coloring (backwards compatible)
- Tracks collapsed consensus groups with local signal state

### New Exports
- `PairVibeSource` type: Union of known source strings
- `getSourceColor(source)`: Get color for source
- `isPairVibeSource(source)`: Check if source is Pair Vibe related
- `getSourcePrefix(source)`: Get display prefix for source
- `isConsensusStart(entry)`: Check if entry starts consensus
- `isConsensusEnd(entry)`: Check if entry ends consensus
- `groupLogsWithConsensus(logs, collapsed)`: Group logs with consensus sections

### Type check: PASSED
### Tests: 729/729 PASSED (36 new tests added)

---

## impl-012: Implement /consensus command
**Completed:** 2026-01-18T13:50:00.000Z

### Summary
Implemented the `/consensus` slash command for Pair Vibe Mode, allowing users to manually trigger consensus mode for the current step when they notice an issue before the Reviewer does.

### Changes Made

#### 1. Type Definitions (src/tui/commands/types.ts)
- Added `"consensus"` to `CommandName` union type
- Added `ConsensusCommandArgs` interface with `reason: string` field

#### 2. Parser (src/tui/commands/parser.ts)
- Added consensus command definition:
  - Category: `control`
  - Description: "Manually trigger consensus mode for the current step (Pair Vibe Mode only)"
  - Usage: `/consensus <reason>`
  - Requires at least 1 argument (the reason)
  - maxArgs: -1 (unlimited, joins all args as reason)
- Added `parseConsensusArgs()` function
- Updated re-exports to include `ConsensusCommandArgs`

#### 3. Command Handler (src/tui/commands/consensus.ts)
New file with:
- `executeConsensusCommand(options)`: Main command executor
  - Validates Pair Vibe Mode is active
  - Gets PairVibeEngine from store
  - Checks engine is running and not already in consensus
  - Calls `engine.triggerConsensus(reason)`
- `handleConsensusCommand(input)`: Convenience wrapper for raw input
- `triggerConsensus(reason, showInLogs)`: Direct API without parsing
- `canTriggerConsensus()`: Check if consensus can be triggered
- `getConsensusHelp()`: Help text for the command

#### 4. Store Updates (src/tui/state/store.ts)
- Added `pairVibeEngine` signal to store reference to running engine
- Added `registerPairVibeEngine(engine)`: Register/unregister engine
- Added `getPairVibeEngine()`: Get current engine for commands
- Updated `reset()` to clear engine reference
- Exported new functions in store object

#### 5. Ralph Command Integration (src/commands/ralph.ts)
- Imported `handleConsensusCommand` from commands
- In `runPairVibeTuiMode()`:
  - Register engine with store after creation
  - Unregister engine in finally block
- Added `"consensus"` case to command switch in `handleTuiCommand()`

#### 6. Index Exports (src/tui/commands/index.ts)
- Added `parseConsensusArgs` to parser exports
- Added consensus command exports:
  - `executeConsensusCommand`
  - `handleConsensusCommand`
  - `triggerConsensus`
  - `canTriggerConsensus`
  - `getConsensusHelp`
- Added `ConsensusCommandOptions` type export
- Added `ConsensusCommandArgs` type export

#### 7. Test Updates (tests/tui/parser.test.ts)
- Updated command count expectations from 10 to 11
- Added `'consensus'` to expected commands list

### Usage
```
/consensus <reason>
```

Examples:
- `/consensus I have concerns about this approach`
- `/consensus Need to discuss security implications`
- `/consensus This approach might not scale well`

### Validation
- Only works when Pair Vibe Mode is active
- Engine must be running
- Cannot trigger if already in consensus mode
- Reason is required (at least 1 argument)

### Type check: PASSED
### Tests: 729/729 PASSED

## impl-013: Implement /reviewer command

**Completed:** 2026-01-18T13:58:00.000Z

### Summary
Implemented `/reviewer` command with 4 subcommands to control the Reviewer in Pair Vibe Mode. This is useful when the Reviewer is slow or stuck.

### Subcommands
- `/reviewer status` - Shows Reviewer state, current step being reviewed, and count of reviewed steps
- `/reviewer pause` - Pauses look-ahead review
- `/reviewer resume` - Resumes look-ahead review
- `/reviewer skip <step-id>` - Skips reviewing a specific step (marks it as reviewed without actually reviewing)

### Files Changed

#### 1. New File: src/tui/commands/reviewer.ts
Created complete reviewer command handler with:
- `ReviewerSubcommand` type for subcommands
- `ReviewerCommandOptions` interface
- `ReviewerStatusInfo` interface with state, currentStep, reviewedCount, reviewedSteps
- `parseReviewerArgs()` function to parse subcommand and arguments
- `executeStatus()` - Shows state and progress
- `executePause()` - Pauses the ReviewerRunner
- `executeResume()` - Resumes the ReviewerRunner
- `executeSkip()` - Skips reviewing a step
- `executeReviewerCommand()` - Main handler
- `handleReviewerCommand()` - Convenience wrapper
- `canUseReviewerCommands()` - Checks if commands are available
- `getReviewerStatus()` - Gets status directly without logs
- `getReviewerHelp()` - Returns help text
- `formatState()` - Formats ReviewerState for display

#### 2. Types Update (src/tui/commands/types.ts)
- Added `"reviewer"` to `CommandName` union type
- Added `ReviewerCommandArgs` interface with subcommand and optional stepId

#### 3. Parser Update (src/tui/commands/parser.ts)
- Added `ReviewerCommandArgs` to imports
- Added `reviewer` command definition to `COMMAND_DEFINITIONS`:
  - category: "control"
  - requiresArgs: true
  - minArgs: 1, maxArgs: 2
  - Examples for all 4 subcommands
- Added `parseReviewerArgs()` function
- Added `ReviewerCommandArgs` to re-exports
- Updated module docstring to include /reviewer

#### 4. Index Exports (src/tui/commands/index.ts)
- Added `parseReviewerArgs` to parser exports
- Added reviewer command exports:
  - `executeReviewerCommand`
  - `handleReviewerCommand`
  - `canUseReviewerCommands`
  - `getReviewerStatus`
  - `getReviewerHelp`
- Added type exports: `ReviewerCommandOptions`, `ReviewerSubcommand`, `ReviewerStatusInfo`
- Added `ReviewerCommandArgs` to type exports

#### 5. Ralph Command Integration (src/commands/ralph.ts)
- Imported `handleReviewerCommand` from commands
- Added `"reviewer"` case to command switch in `handleTuiCommand()`

#### 6. Test Updates (tests/tui/parser.test.ts)
- Updated command count expectations from 11 to 12
- Added `'reviewer'` to expected commands list

### Usage
```
/reviewer status              # Show Reviewer progress and state
/reviewer pause               # Pause look-ahead review
/reviewer resume              # Resume look-ahead review
/reviewer skip <step-id>      # Skip reviewing a specific step
```

Examples:
- `/reviewer status` - See what Reviewer is doing
- `/reviewer pause` - Stop Reviewer when it's consuming too many API calls
- `/reviewer resume` - Continue reviewing
- `/reviewer skip impl-015` - Skip a step that doesn't need review

### Validation
- Only works when Pair Vibe Mode is active
- Engine must be available (getPairVibeEngine returns non-null)
- ReviewerRunner accessed via engine.getReviewerRunner()
- Pause/resume respect current state (can't pause if already paused, etc.)
- Skip marks step as reviewed without actual review

### Type check: PASSED
### Tests: 729/729 PASSED

## 2026-01-18 - impl-014: Update ralph.sh for Pair Vibe Mode

### Completed
- Added Pair Vibe Mode support to `ralph.sh` shell script
- New CLI flags:
  - `--pair-vibe`: Enable Pair Vibe Mode (concurrent review)
  - `--no-pair-vibe`: Disable Pair Vibe Mode (single model)
  - `--executor <provider>`: Set executor (anthropic or openai)
  - `--reviewer <provider>`: Set reviewer (anthropic or openai)
- API key detection via `can_enable_pair_vibe()` function
- Interactive prompts:
  - Executor/Reviewer assignment with numbered selection (1=Anthropic, 2=OpenAI)
  - Cost warning with 2-4x multiplier estimate and breakdown
  - Confirmation before proceeding
- Validation:
  - Ensures executor and reviewer are different providers
  - Auto-infers missing role from the other (e.g., --executor anthropic sets reviewer to openai)
  - Validates API keys are present when --pair-vibe is used
- Config passing via `get_pair_vibe_flags()` to docker sandbox run claude
- Status display in AFK and interactive modes shows Pair Vibe Mode status
- Updated help text with Pair Vibe Mode options section

### Technical Details
- Uses PAIR_VIBE_MODE variable: "", "enabled", "disabled"
- PAIR_VIBE_EXECUTOR and PAIR_VIBE_REVIEWER track provider assignments
- Flags passed to bootstralph ralph command for TypeScript integration
- Supports both "anthropic"/"openai" and "claude"/"gpt" as provider aliases

### Bash syntax check: PASSED
### Type check: PASSED
### Tests: 729/729 PASSED

## 2026-01-18 - impl-015: Update afk-ralph.sh for Pair Vibe Mode

### Completed
- Recreated `afk-ralph.sh` with full Pair Vibe Mode support for AFK (unattended) operation
- New CLI flags:
  - `--pair-vibe`: Enable Pair Vibe Mode with AFK defaults
  - `--no-pair-vibe`: Disable Pair Vibe Mode (single model)
  - `--executor <provider>`: Set executor (anthropic/claude or openai/gpt)
  - `--reviewer <provider>`: Set reviewer (anthropic/claude or openai/gpt)
- AFK Mode Defaults:
  - Executor: Claude/Anthropic (more capable for complex implementation)
  - Reviewer: OpenAI/GPT (faster for search synthesis)
- Features:
  - `can_enable_pair_vibe()` - Validates both API keys are present
  - `apply_pair_vibe_defaults()` - Sets Claude as Executor, OpenAI as Reviewer for AFK
  - `build_pair_vibe_flags()` - Constructs flags for ralph.sh
  - Automatic role inference (if only executor specified, reviewer is set to opposite)
  - Validation that executor and reviewer are different providers
  - Colored output for status display
  - Passes all flags through to `ralph.sh afk` command
  - Maintains backward compatibility with legacy `prd.json` fallback

### Usage
```bash
# Basic AFK with Pair Vibe Mode (uses defaults)
./afk-ralph.sh 20 --pair-vibe

# AFK with custom role assignment
./afk-ralph.sh 15 --pair-vibe --executor openai --reviewer anthropic

# AFK with single model (explicit disable)
./afk-ralph.sh 10 --no-pair-vibe

# Combined with PRD selection
./afk-ralph.sh 20 --pair-vibe --prd .agents/tasks/prd-feature.json
```

### Technical Details
- Script wraps ralph.sh, passing iterations and Pair Vibe flags
- Validates API key availability before enabling Pair Vibe Mode
- Uses exec to replace shell process with ralph.sh
- Maintains original fallback to legacy prd.json for backward compatibility

### Bash syntax check: PASSED
### Type check: PASSED
### Tests: 729/729 PASSED

## 2026-01-18 - impl-016: Implement rate limit handler with backoff

### Completed
- Created `src/ralph/rate-limiter.ts` with RateLimiter class
- Implemented per-provider rate limiting with full spec compliance per review-005 findings

### Features
1. **Full Jitter Exponential Backoff** (AWS best practice)
   - Formula: `sleep = random(0, min(cap, base * 2^attempt))`
   - Base delay: 1 second
   - Maximum cap: 60 seconds
   - Maximum attempts: 6

2. **Per-Provider Rate Limit Tracking**
   - Anthropic headers: `anthropic-ratelimit-{requests,tokens}-{limit,remaining,reset}`
   - OpenAI headers: `x-ratelimit-{limit,remaining,reset}-{requests,tokens}`
   - Automatic parsing of ISO 8601 and relative time formats

3. **Retry-After Header Respect**
   - Parses both seconds format (e.g., "60") and HTTP-date format
   - Used as backoff delay when available

4. **Token Bucket Algorithm**
   - Proactive rate limiting to avoid hitting limits
   - Per-provider token buckets with automatic refill
   - shouldWait() method for pre-request checking

5. **Circuit Breaker Pattern**
   - Three states: closed, open, half-open
   - Opens after 5 consecutive 429 errors within 60s
   - Stays open for 2 minutes (per review-005)
   - Half-open allows 1 test request before closing

6. **Graceful Degradation**
   - markDegraded(provider, reason) / isDegraded(provider) / clearDegraded(provider)
   - getAvailableProviders() returns non-degraded, non-circuit-open providers
   - Supports continuing with single model when one provider fails

7. **Event Emission**
   - PairVibeEvent types: rate-limit-hit, rate-limit-recovered
   - Circuit breaker events: circuit-open, circuit-half-open, circuit-closed
   - Degradation events: degraded-mode

### API
```typescript
// Create rate limiter
const limiter = createRateLimiter(backoffConfig?, circuitConfig?);

// Or use global singleton
const limiter = getGlobalRateLimiter();

// Initialize provider
limiter.initProvider('anthropic');

// Execute with rate limiting
const result = await limiter.execute('anthropic', async () => {
  return await callApi();
}, {
  extractHeaders: (response) => response.headers,
  is429Error: (error) => error.status === 429,
  getRetryAfter: (error) => error.headers['retry-after'],
});

// Check circuit state
limiter.getCircuitState('anthropic'); // 'closed' | 'open' | 'half-open'

// Check degraded status
limiter.isDegraded('anthropic');
```

### Configuration
- BackoffConfig: baseDelayMs (1000), maxDelayMs (60000), maxAttempts (6), useJitter (true)
- CircuitBreakerConfig: failureThreshold (5), failureWindowMs (60000), resetTimeoutMs (120000), halfOpenRequests (1)

### Type check: PASSED
### Tests: 729/729 PASSED

## 2026-01-18 - impl-017: Implement PRD file locking

### Completed
- Created `src/ralph/prd-lock.ts` with PrdLock class for concurrent access safety
- Prevents race conditions when Reviewer and Executor both update PRD in Pair Vibe Mode
- Implements strategy from review-004 findings

### Features
- **async-lock integration**: In-process serialization for PRD writes
- **withLock()**: Execute function with exclusive file access
- **writeWithLock()**: Atomic file write with temp file + rename pattern
- **Timeout**: 5 seconds per review-004 spec
- **Retries**: 3 attempts with exponential backoff (100ms, 200ms, 400ms)
- **getPrdLock()**: Singleton lock instance per PRD path
- **Event emission**: lock-retry and lock-failed events for TUI integration

### PrdManager Integration
- Added `enableLocking()` / `disableLocking()` methods
- `save()` automatically uses locked writes when locking is enabled
- Constructor accepts `enableLocking` option
- `isLockingEnabled()` to check current state

### Event Types Added to PairVibeEvent
```typescript
| { type: "lock-retry"; path: string; attempt: number; maxRetries: number; timestamp: number }
| { type: "lock-failed"; path: string; error: string; retriesUsed: number; timestamp: number }
```

### Dependencies Added
- `async-lock` (runtime)
- `@types/async-lock` (dev)

### Type check: PASSED
### Tests: 729/729 PASSED

## 2026-01-18 - impl-018: Add Pair Vibe metrics and logging

### Completed
- Created `src/ralph/pair-vibe-metrics.ts` with PairVibeMetricsService class
- Comprehensive metrics tracking for Pair Vibe Mode sessions

### Features

1. **PairVibeMetricsService Class**
   - Collects and persists metrics during Pair Vibe Mode sessions
   - Auto-saves to `.agents/metrics/pair-vibe-{timestamp}.json`
   - Handles all PairVibeEvent types for metric updates

2. **Per-Step Metrics (DetailedStepMetrics)**
   - Token usage breakdown (review, execution, consensus)
   - Duration tracking (review, execution, consensus)
   - Web search count per step
   - Findings and consensus decision tracking
   - Model attribution (review model, execution model)
   - Passed without review flag

3. **Model Pricing (MODEL_PRICING)**
   - Claude Sonnet 4: $3/M input, $15/M output
   - Claude Opus 4: $15/M input, $75/M output
   - GPT-4o: $2.50/M input, $10/M output
   - GPT-4.1: $2/M input, $8/M output
   - o1/o3/o3-mini pricing per review-008 findings
   - 90% cache discount for Anthropic prompt caching

4. **Cost Tracking**
   - Real-time cost calculation from token usage
   - Breakdown by role: executor, reviewer, consensus, webSearch
   - Web search cost: $0.008/query (Tavily pricing per review-002)
   - `recordTokenUsage()` for external cost tracking

5. **Phase Timing**
   - Tracks time spent in each PairVibePhase
   - Records start/end timestamps and duration
   - `phaseTimings` array in DetailedPairVibeMetrics

6. **Reviewer Ahead Distance**
   - `reviewerAheadSamples` array with timestamp and distance
   - Running average calculation (`averageReviewerAhead`)
   - `recordReviewerAhead()` for engine integration

7. **Session Summary (generateSummary)**
   - Human-readable summary for end-of-session display
   - Duration, progress, cost breakdown
   - Consensus statistics (triggered, rounds, outcomes)
   - Review statistics (completed, timeouts, findings)
   - Reliability info (rate limits, circuit trips, degraded time)
   - Performance hints based on metrics analysis

8. **Console Formatting (formatSummaryForConsole)**
   - ASCII box formatting for terminal display
   - Organized sections with clear headings
   - Cost breakdown with proper alignment
   - Performance hints with bullet points

9. **Sycophancy Risk Detection**
   - Tracks consensus rounds with high similarity (>95%)
   - Flags fast consensus (<30s in round 1)
   - `sycophancyRiskCount` metric

10. **Circuit Breaker Events**
    - Records provider, state (open/half-open/closed), timestamp
    - Supports reliability analysis

11. **Cost Estimation (estimateCostMultiplier)**
    - Pre-session cost multiplier estimation
    - Based on expected consensus rate
    - Low/medium/high friction categories

### API

```typescript
// Create metrics service
const metricsService = createPairVibeMetricsService({
  metricsDir: '.agents/metrics',
  config: pairVibeConfig,
  autoSave: true,
  autoSaveInterval: 30000,
});

// Start collection
metricsService.start();

// Handle events from PairVibeEngine
metricsService.handleEvent(event);

// Record token usage (from LLM responses)
metricsService.recordTokenUsage('step-1', 'executor', {
  inputTokens: 1000,
  outputTokens: 500,
  cachedInputTokens: 800,
});

// Record reviewer ahead distance
metricsService.recordReviewerAhead(3);

// Get current metrics
const metrics = metricsService.getMetrics();

// Generate end-of-session summary
const summary = metricsService.generateSummary();
console.log(metricsService.formatSummaryForConsole(summary));

// Stop and save
await metricsService.stop('completed');
```

### Types Added
- `TokenUsage`: inputTokens, outputTokens, cachedInputTokens
- `PhaseTiming`: phase, startedAt, endedAt, durationMs
- `DetailedStepMetrics`: extends StepMetrics with token usage, models, findings
- `DetailedPairVibeMetrics`: extends PairVibeMetrics with detailed tracking
- `PairVibeSessionSummary`: summary for display
- `PairVibeMetricsServiceOptions`: service configuration

### Constants
- `MODEL_PRICING`: Per-model token pricing
- `WEB_SEARCH_COST_PER_QUERY`: $0.008 (Tavily)

### Type check: PASSED
### Tests: 729/729 PASSED
## 2026-01-18T15:18:18+01:00
Max iterations reached (25)
## 2026-01-18T14:30:00+01:00
### impl-019: Add cost estimation and warning

Created `src/ralph/cost-estimator.ts` for pre-session cost estimation in Pair Vibe Mode.

### Features Implemented

1. **countPendingSteps(prd)**
   - Counts pending steps across review_tasks, implementation_tasks, userStories, and reviewTasks
   - Supports both standard Prd and ExtendedPrd formats

2. **suggestConsensusRate(prd)**
   - Analyzes task complexity based on description keywords
   - Returns 'low' (10%), 'medium' (25%), or 'high' (40%) consensus rate
   - Complexity indicators: refactor, integration, auth, database, API, multiple

3. **estimatePairVibeCost(prd, config, options)**
   - Calculates detailed cost breakdown:
     - Executor cost (all steps)
     - Reviewer cost (all steps, ~40% of executor output)
     - Consensus cost (based on expected consensus rate)
     - Web search cost ($0.008/query via Tavily)
   - Accounts for cache discounts (90% for cached input tokens)
   - Returns min/max range based on low/high consensus rates

4. **formatCostEstimate(estimate)**
   - ASCII box formatting for terminal display
   - Shows step count, consensus rate, cost breakdown, total, range, multiplier

5. **formatCostWarning(estimate)**
   - Short warning message for prompts

6. **getCostWarningLevel(estimate)**
   - Returns 'none', 'info', 'warn', or 'danger' based on thresholds
   - danger: >$10, warn: >$5, info: >$1

7. **getCostRecommendation(estimate)**
   - Returns actionable advice based on cost level

8. **estimateSingleModelCost(prd, model)**
   - Baseline cost for comparison

9. **compareCosts(prd, config)**
   - Compares Pair Vibe vs single-model cost
   - Returns recommendation based on multiplier

### Token Estimates Used
- Executor: 8K input, 2K output per step
- Reviewer: 4K input, 500 output per step  
- Consensus: 6K input, 1.5K output per round
- Web searches: 1.5 per step average

### Type check: PASSED
### Tests: 729/729 PASSED

## 2026-01-18 - impl-020: Write unit tests for ReviewerRunner

### Completed
- Created `tests/ralph/reviewer-runner.test.ts` with 65 comprehensive unit tests
- Tests cover all requirements from PRD impl-020 specification

### Test Categories

1. **Initialization and State Tests** (5 tests)
   - Idle state initialization
   - Null current step initially
   - Empty reviewed steps set
   - Zero reviewed count
   - Default web search service creation

2. **Look-Ahead Execution Tests** (7 tests)
   - Starting review from ahead of executor index
   - Respecting MAX_STEPS_AHEAD limit (5 steps)
   - Skipping already reviewed steps (findings !== undefined)
   - Emitting caughtUp event when done
   - Returning to idle state after catching up
   - Throwing error if started while already running

3. **Findings Population Tests** (6 tests)
   - Populating empty findings when LLM finds no issues
   - Populating findings when LLM finds issues
   - Emitting consensus-needed event when findings exist
   - Not emitting consensus-needed when findings empty
   - Tracking reviewed steps
   - Emitting PairVibe events during review

4. **Cancellation and Pause/Resume Tests** (11 tests)
   - Pause when requested
   - Emit paused event with reason
   - Emit PairVibe paused event
   - Resume from paused state
   - Emit resumed event
   - No pause if not running
   - No resume if not paused
   - Stop execution when stop() called
   - Wait for consensus when running
   - Return immediately from waitForConsensus if not running
   - consensusCompleted() transitions from waiting to running

5. **Web Search Mocking Tests** (6 tests)
   - Calling web search service during review
   - Passing search results to LLM client
   - Proceeding without search when not available
   - Proceeding without search when disabled in config
   - Extracting findings heuristically when LLM unavailable
   - Emitting web-search-started event

6. **Timeout Handling Tests** (5 tests)
   - Timing out review after configured duration
   - Emitting reviewer-timeout event
   - Still marking step as reviewed after timeout
   - Using default timeout when not configured
   - Measuring duration correctly

7. **Error Recovery Tests** (5 tests)
   - Handling LLM client errors gracefully
   - Handling web search errors gracefully
   - Still tracking step as reviewed after error
   - Clearing current step after error
   - Emitting stepCompleted even on error

8. **Reset and Skip Tests** (3 tests)
   - Resetting all state
   - Skipping specific steps
   - Not reviewing skipped steps

9. **Search Query Generation Tests** (5 tests)
   - Generating queries for React-related steps
   - Generating security queries for auth-related steps
   - Generating performance queries for performance-related steps
   - Limiting queries to 3
   - Generating default query when no tech detected

10. **Factory Function Tests** (3 tests)
    - Creating ReviewerRunner via createReviewerRunner
    - Creating default LLM client via createDefaultReviewerLLMClient
    - Extracting findings from search results in default LLM client

11. **LLM Client Setter Tests** (1 test)
    - Allowing setting LLM client after construction

12. **PairVibe Event Emission Tests** (5 tests)
    - Emitting reviewer-started event
    - Emitting reviewer-completed event with findings status
    - Emitting consensus-started event when findings exist
    - Not emitting events when no event handler provided
    - Emitting resumed event

13. **Edge Cases Tests** (5 tests)
    - Handling empty steps array
    - Handling executor at end of steps
    - Handling step with null findings (not reviewed)
    - Handling concurrent start calls correctly
    - Preserving reviewed steps across multiple start calls

### Technical Details
- Uses Vitest with fake timers for timeout testing
- Mock implementations for WebSearchService and ReviewerLLMClient
- Event collection helpers for testing EventEmitter behavior
- Comprehensive PairVibeEvent emission verification

### Type check: PASSED
### Tests: 794/794 PASSED

## impl-021: Write unit tests for ConsensusRunner

**Status**: Completed
**Date**: 2026-01-18T15:00:00.000Z
**Files Created**: tests/ralph/consensus-runner.test.ts

### Summary
Implemented comprehensive unit tests for the ConsensusRunner class, which orchestrates consensus resolution between Executor and Reviewer models when findings are identified.

### Test Categories (68 tests total)

1. **Initialization and State Tests** (5 tests)
   - Idle state initialization
   - Null current session initially
   - Config option acceptance
   - Web search service creation
   - Provided web search service usage

2. **Alignment Detection Tests** (4 tests)
   - Detecting aligned proposals and resolving consensus
   - Tracking proposal similarity score
   - Detecting misaligned proposals
   - Using simple similarity check when no LLM available

3. **Multi-Round Escalation Tests** (5 tests)
   - Proceeding to round 2 when round 1 not aligned
   - Triggering ultrathink on round 2
   - Aligning on second round when proposals converge
   - Performing web search in ultrathink mode
   - Skipping web search when disabled in config

4. **Executor-Wins Tiebreaker Tests** (3 tests)
   - Giving executor win after max rounds (per core_philosophy)
   - Using executor proposal as final decision
   - Respecting configured max rounds

5. **Anonymization Tests (edge-006)** (3 tests)
   - Labeling proposals as A/B not executor/reviewer
   - Randomizing which model is A vs B
   - Preserving source in proposal for internal tracking

6. **Timeout Handling Tests** (4 tests)
   - Using default timeout when not configured
   - Respecting custom consensus timeout configuration
   - Tracking timeout remaining in session
   - Recording duration in result

7. **Decision Recording Tests** (4 tests)
   - Recording consensus result with all required fields
   - Converting result to ConsensusRecord for PRD storage
   - Adding notes when ultrathink was used
   - Tracking duration in milliseconds

8. **Cancellation Tests (edge-007)** (4 tests)
   - Setting state to cancelled when cancel called during consensus
   - Not cancelling if already idle
   - Not cancelling if already resolved
   - Preserving state after cancelling resolved consensus

9. **Reset and Cleanup Tests** (3 tests)
   - Resetting state to idle
   - Allowing new consensus after reset
   - Throwing if resolve called while not idle

10. **PairVibe Event Emission Tests** (4 tests)
    - Emitting consensus-started event
    - Emitting consensus-round events
    - Emitting consensus-completed event
    - Not emitting events when no handler provided

11. **Sycophancy Detection Tests** (2 tests)
    - Detecting suspiciously quick consensus
    - Flagging very short reasoning as potential sycophancy

12. **Factory Functions Tests** (3 tests)
    - Creating ConsensusRunner via createConsensusRunner
    - Creating default LLM clients via createDefaultConsensusLLMClients
    - Using default clients for basic operation

13. **Helper Functions Tests** (6 tests)
    - needsConsensus with non-empty findings returns true
    - needsConsensus with empty findings returns false
    - needsConsensus with no findings property returns false
    - needsConsensus with null findings returns false
    - hasConsensusRecord returns true when record exists
    - hasConsensusRecord returns false when no/null record

14. **Error Handling Tests** (4 tests)
    - Throwing when all proposals fail across all rounds
    - Emitting error event when consensus loop fails
    - Throwing when only one model consistently fails
    - Recovering if errors are intermittent and eventually succeed

15. **Web Search Integration Tests** (3 tests)
    - Generating search queries from step and findings
    - Limiting search queries to prevent overload
    - Handling web search failures gracefully

16. **Session State Tests** (4 tests)
    - Tracking current session during consensus
    - Updating session round count
    - Tracking ultrathink trigger in session
    - Tracking web search usage in session

17. **Edge Cases Tests** (6 tests)
    - Handling empty findings array
    - Handling very long findings
    - Handling step with special characters in ID
    - Handling step with minimal data
    - Handling concurrent resolve attempts correctly
    - Handling setExecutorClient/setReviewerClient after construction

### Technical Details
- Uses Vitest with fake timers for most tests
- Real timers with short timeouts for timeout/cancellation tests requiring async timing
- Mock implementations for ConsensusLLMClient and WebSearchService
- Event collection helpers for testing EventEmitter behavior
- Comprehensive PairVibeEvent emission verification
- Tests verify all edge cases from PRD (edge-003, edge-006, edge-007)

### Type check: PASSED
### Tests: 862/862 PASSED
